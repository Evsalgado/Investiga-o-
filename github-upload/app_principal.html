<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestigIA Pro - Customiz√°vel</title>
    <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Garantir que os √≠cones FontAwesome sejam carregados */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');
        
        /* Estilo para √≠cones no grafo */
        .fa, .fas, .far, .fal, .fab {
            font-family: "Font Awesome 5 Free", "Font Awesome 5 Pro", "Font Awesome 5 Brands" !important;
            font-weight: 900 !important;
        }
        :root {
            --primary-color: #60a5fa;
            --secondary-color: #3b82f6;
            --accent-color: #1d4ed8;
            --ml-yellow: #fbbf24;
            --ml-blue: #60a5fa;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e0f2fe;
            --shadow-sm: 0 1px 2px 0 rgba(96, 165, 250, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(96, 165, 250, 0.12);
            --shadow-lg: 0 10px 15px -3px rgba(96, 165, 250, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #93c5fd 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--background);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: rgba(5, 150, 105, 0.05);
        }

        .upload-area.drag-over {
            border-color: var(--accent-color);
            background: rgba(5, 150, 105, 0.1);
            transform: scale(1.02);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-label {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .upload-label:hover {
            background: #047857;
            transform: translateY(-2px);
        }

        .field-selector {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
        }

        .field-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .field-group select {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .field-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .field-group select:hover {
            border-color: var(--accent-color);
        }

        /* Customiza√ß√£o Visual */
        .customization-panel {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 197, 253, 0.1) 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            color: #1f2937;
            border: 1px solid rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        .customization-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-top: 20px;
        }

        .customization-grid h4 {
            color: #1d4ed8;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .icon-selector {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 12px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .icon-option {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 1.8rem;
            backdrop-filter: blur(10px);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            color: #1f2937;
            overflow: hidden;
        }

        .icon-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .icon-option:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.2));
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.4);
        }

        /* √çcone POS customizado - baseado na imagem enviada */
        .pos-icon {
            display: inline-block;
            width: 22px;
            height: 32px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 6px;
            position: relative;
            margin: 0 auto;
            border: 2px solid #4a5568;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Papel/recibo no topo */
        .pos-icon::before {
            content: '';
            position: absolute;
            top: -3px;
            left: 4px;
            right: 4px;
            height: 4px;
            background: #f7fafc;
            border-radius: 1px;
            border: 1px solid #e2e8f0;
        }

        /* Tela azul */
        .pos-icon::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            height: 8px;
            background: linear-gradient(135deg, #3182ce, #2c5282);
            border-radius: 2px;
            border: 1px solid #2a4365;
        }

        /* Bot√µes do teclado */
        .pos-icon .keypad {
            position: absolute;
            top: 14px;
            left: 3px;
            right: 3px;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                #4a5568 0px,
                #4a5568 2px,
                #2d3748 2px,
                #2d3748 4px
            );
            border-radius: 1px;
        }

        /* Bot√µes coloridos na parte inferior */
        .pos-icon .color-buttons {
            position: absolute;
            bottom: 2px;
            left: 3px;
            right: 3px;
            height: 3px;
            background: linear-gradient(
                90deg,
                #48bb78 0%,
                #48bb78 33%,
                #ed8936 33%,
                #ed8936 66%,
                #f56565 66%,
                #f56565 100%
            );
            border-radius: 1px;
        }

        .icon-option:hover::before {
            left: 100%;
        }

        .icon-option.selected {
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.4), rgba(251, 191, 36, 0.2));
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3);
            transform: scale(1.1);
        }

        .color-selector {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #fbbf24;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.5);
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-minimize {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-minimize:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .section-collapsed {
            display: none !important;
        }

        .section-expanded {
            display: block !important;
        }

        .controls {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(29, 78, 216, 0.15) 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            color: #1f2937;
            border: 1px solid rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(10px);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group h4 {
            margin: 0 0 15px 0;
            color: #fbbf24;
            font-size: 1.1rem;
            font-weight: 600;
        }

        #cy {
            width: 100%;
            height: 600px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: #f8fafc;
            margin: 20px 0;
        }

        .legend-container {
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .legend-section h5 {
            margin: 0 0 12px 0;
            color: #fbbf24;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #ffffff;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.2);
        }

        .legend-line {
            width: 30px;
            height: 2px;
            border-radius: 2px;
        }

        .legend-node {
            border-radius: 50%;
            border: 2px solid #ffffff;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.3s ease;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #059669;
        }

        .toast.error {
            background: #dc2626;
        }

        .toast.warning {
            background: #d97706;
        }

        .toast.info {
            background: #2563eb;
        }

        /* Responsividade para dispositivos m√≥veis */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .icon-grid {
                grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
                gap: 8px;
                max-height: 150px;
            }
            
            .icon-option {
                padding: 10px;
                min-height: 50px;
                font-size: 1.4rem;
            }
            
            .field-grid {
                grid-template-columns: 1fr;
            }
            
            .legend-grid {
                grid-template-columns: 1fr;
            }
            
            #cy {
                height: 400px;
            }
            
            .toast {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .control-group {
                padding: 15px;
            }
            
            .icon-grid {
                grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
                max-height: 120px;
            }
            
            .icon-option {
                font-size: 1.2rem;
                min-height: 40px;
                padding: 8px;
            }
            
            .btn-minimize {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }

        /* Estilos do Painel de Transa√ß√µes */
        .transactions-panel {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transaction-filters {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #fbbf24;
        }

        .filter-group input {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .transactions-table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
        }

        .transactions-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3));
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .stat-card h5 {
            margin: 0 0 5px 0;
            color: #60a5fa;
            font-size: 0.9rem;
        }

        .stat-card p {
            margin: 0;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            overflow: hidden;
        }

        .transactions-table th {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .transactions-table th:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .transactions-table th i {
            margin-left: 5px;
            opacity: 0.7;
        }

        .transactions-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .transactions-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .transaction-value {
            font-weight: bold;
            color: #10b981;
        }

        .transaction-value.high {
            color: #ef4444;
        }

        .transaction-value.medium {
            color: #f59e0b;
        }

        .action-btn {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            color: #60a5fa;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(59, 130, 246, 0.4);
            transform: scale(1.05);
        }

        /* Painel de An√°lise IA */
        .ai-analysis-panel {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
            color: white;
            box-shadow: 0 20px 40px rgba(124, 58, 237, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-insight {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #fbbf24;
        }

        .ai-insight h6 {
            margin: 0 0 8px 0;
            color: #fbbf24;
            font-weight: 600;
        }

        .ai-insight p {
            margin: 0;
            line-height: 1.5;
        }

        /* Melhorias na formata√ß√£o profissional */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header h1, .header p {
            position: relative;
            z-index: 2;
        }

        #cy {
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        /* Estilos para elementos destacados no grafo */
        .highlighted {
            border-width: 4px !important;
            border-color: #fbbf24 !important;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6) !important;
        }

        .selected {
            border-width: 6px !important;
            border-color: #ef4444 !important;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.8) !important;
        }

        /* Painel de informa√ß√µes do n√≥ */
        .node-info-panel {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">

            <h1>üîç InvestigIA Pro - Enhanced</h1>
                            <p>An√°lise Visual Avan√ßada com IA para Transa√ß√µes Financeiras</p>
        </div>

        <div class="main-content">
            <!-- Upload de Dados -->
            <div class="upload-area" id="uploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <i class="fas fa-upload" style="font-size: 3rem; color: var(--accent-color); margin-bottom: 20px;"></i>
                <h3>Carregue seus dados</h3>
                <p>Suporta arquivos CSV, Excel (.xlsx) e XML</p>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                    <i class="fas fa-hand-paper"></i> Arraste e solte aqui ou clique para escolher
                </p>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xml" onchange="handleFileUpload(event)">
                <label for="fileInput" class="upload-label">
                    <i class="fas fa-file-upload"></i> Escolher Arquivo
                </label>
            </div>

            <!-- Sele√ß√£o de Campos -->
            <div id="fieldSelector" class="field-selector" style="display: none;">
                <h4 style="margin-bottom: 20px; color: var(--primary-color);">
                    <i class="fas fa-cogs"></i> Configurar An√°lise do Grafo
                </h4>
                
                <div class="field-grid">
                    <div class="field-group">
                        <label>Campo de Origem:</label>
                        <select id="sourceField">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    
                    <div class="field-group">
                        <label>Campo de Destino:</label>
                        <select id="targetField">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    
                    <div class="field-group">
                        <label>Campo de Valor:</label>
                        <select id="valueField">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                    <strong>üí° Dica:</strong> 
                    <span id="fieldHint">Carregue um arquivo para ver as colunas dispon√≠veis</span>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="showCustomizationPanel()" class="btn-primary">
                        <i class="fas fa-palette"></i> Personalizar Visual
                    </button>
                </div>
            </div>

            <!-- Painel de Customiza√ß√£o Visual -->
            <div id="customizationPanel" class="customization-panel" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0;">
                        <i class="fas fa-paint-brush"></i> Personaliza√ß√£o Visual por Campo
                    </h4>
                    <button onclick="toggleSection('customizationContent')" class="btn-minimize" id="customizationToggle">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <p style="opacity: 0.9; margin-bottom: 20px;">
                    Configure √≠cones para TODOS os elementos de cada campo. As cores s√£o autom√°ticas por valor movimentado.
                </p>
                
                <div id="customizationContent">
                    <div id="customizationInner">
                        <!-- Conte√∫do ser√° gerado dinamicamente -->
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                        <h6 style="margin-bottom: 10px; color: #fbbf24;">üé® Sistema de Cores Autom√°tico:</h6>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            üî¥ ‚â•R$ 1M ‚Ä¢ üü† ‚â•R$ 500K ‚Ä¢ üü£ ‚â•R$ 250K ‚Ä¢ üü° ‚â•R$ 100K ‚Ä¢ üîµ ‚â•R$ 50K ‚Ä¢ üî∑ ‚â•R$ 10K ‚Ä¢ üü¢ <R$ 10K
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="generateCustomGraph()" class="btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-project-diagram"></i> Gerar Grafo Personalizado
                        </button>
                        <button onclick="resetCustomization()" class="btn-primary" style="background: #6b7280;">
                            <i class="fas fa-undo"></i> Resetar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Controles -->
            <div class="controls">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">
                        <i class="fas fa-sliders-h"></i> Controles Avan√ßados
                    </h4>
                    <button onclick="toggleSection('controlsContent')" class="btn-minimize" id="controlsToggle">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div id="controlsContent" class="controls-grid">
                    <div class="control-group">
                        <h4><i class="fas fa-project-diagram"></i> Layout do Grafo</h4>
                        <label style="display: block; margin-bottom: 8px;">Tipo de Layout:</label>
                        <select id="layoutSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background: rgba(255,255,255,0.9);">
                            <option value="cose">üîÑ For√ßa (Cose) - Recomendado</option>
                            <option value="breadthfirst">üìä Hier√°rquico</option>
                            <option value="circle">‚≠ï Circular</option>
                            <option value="grid">‚öè Grade</option>
                            <option value="concentric">üéØ Conc√™ntrico</option>
                            <option value="random">üé≤ Aleat√≥rio</option>
                        </select>
                        <button onclick="aplicarLayout()" class="btn-primary" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-play"></i> Aplicar Layout
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <h4><i class="fas fa-download"></i> Exportar Dados</h4>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">Salve sua an√°lise em diferentes formatos</p>
                        <button onclick="exportGraph('png')" class="btn-primary" style="width: 100%; margin-bottom: 8px;">
                            <i class="fas fa-image"></i> Exportar PNG
                        </button>
                        <button onclick="exportGraph('json')" class="btn-primary" style="width: 100%;">
                            <i class="fas fa-file-code"></i> Exportar JSON
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <h4><i class="fas fa-search"></i> Filtros</h4>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">Filtre por valor de transa√ß√£o</p>
                        <label style="display: block; margin-bottom: 5px;">Valor m√≠nimo (R$):</label>
                        <input type="number" id="minValue" placeholder="0" style="width: 100%; padding: 8px; border-radius: 6px; border: none; margin-bottom: 10px;">
                        <button onclick="applyValueFilter()" class="btn-primary" style="width: 100%;">
                            <i class="fas fa-filter"></i> Aplicar Filtro
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <h4><i class="fas fa-robot"></i> An√°lise com IA</h4>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">Otimiza√ß√£o e an√°lise inteligente</p>
                        <button onclick="optimizeGraphWithAI()" class="btn-primary" style="width: 100%; margin-bottom: 8px; background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; border: none; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);">
                            <i class="fas fa-brain"></i> Otimizar Grafo com IA
                        </button>
                        <button onclick="analyzeWithAI()" class="btn-primary" style="width: 100%; margin-bottom: 8px; background: linear-gradient(135deg, #1d4ed8, #1e40af); color: white; border: none; box-shadow: 0 2px 4px rgba(29, 78, 216, 0.2);">
                            <i class="fas fa-search-plus"></i> An√°lise Detalhada com IA
                        </button>
                        <button onclick="toggleStrongConnections()" class="btn-primary" id="strongConnectionsBtn" style="width: 100%; margin-bottom: 8px; background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);">
                            <i class="fas fa-filter"></i> Mostrar Conex√µes Fortes
                        </button>
                        <button onclick="toggleOptimizedAnalysis()" class="btn-primary" id="optimizedAnalysisBtn" style="width: 100%; background: linear-gradient(135deg, #7c3aed, #5b21b6); color: white; border: none; box-shadow: 0 2px 4px rgba(124, 58, 237, 0.2);">
                            <i class="fas fa-bullseye"></i> Otimizar An√°lise
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <h4><i class="fas fa-eye"></i> Visualiza√ß√£o</h4>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">Controles de exibi√ß√£o</p>
                        <button onclick="showTransactionsPanel()" class="btn-primary" style="width: 100%; margin-bottom: 8px;">
                            <i class="fas fa-table"></i> Ver Transa√ß√µes Detalhadas
                        </button>
                        <button onclick="focusOnNode()" class="btn-primary" style="width: 100%;">
                            <i class="fas fa-crosshairs"></i> Focar em N√≥ Selecionado
                        </button>
                    </div>
                </div>
            </div>

            <!-- Container do Grafo -->
            <div id="cy"></div>
            
            <!-- Painel de Transa√ß√µes Detalhadas -->
            <div class="transactions-panel" id="transactionsPanel" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0;">
                        <i class="fas fa-table"></i> Detalhamento de Transa√ß√µes
                    </h4>
                    <button onclick="toggleSection('transactionsContent')" class="btn-minimize" id="transactionsToggle">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                
                <div id="transactionsContent">
                    <!-- Filtros de Transa√ß√µes -->
                    <div class="transaction-filters">
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label>Filtrar por Origem:</label>
                                <input type="text" id="filterOrigin" placeholder="Digite o nome..." onkeyup="filterTransactions()">
                            </div>
                            <div class="filter-group">
                                <label>Filtrar por Destino:</label>
                                <input type="text" id="filterTarget" placeholder="Digite o nome..." onkeyup="filterTransactions()">
                            </div>
                            <div class="filter-group">
                                <label>Valor M√≠nimo (R$):</label>
                                <input type="number" id="filterMinValue" placeholder="0" onchange="filterTransactions()">
                            </div>
                            <div class="filter-group">
                                <label>Valor M√°ximo (R$):</label>
                                <input type="number" id="filterMaxValue" placeholder="999999999" onchange="filterTransactions()">
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="clearFilters()" class="btn-primary" style="background: #6b7280;">
                                <i class="fas fa-eraser"></i> Limpar Filtros
                            </button>
                            <button onclick="exportTransactions('csv')" class="btn-primary" style="margin-left: 10px;">
                                <i class="fas fa-download"></i> Exportar CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabela de Transa√ß√µes -->
                    <div class="transactions-table-container">
                        <div id="transactionsStats" class="transactions-stats">
                            <!-- Estat√≠sticas ser√£o geradas aqui -->
                        </div>
                        <table id="transactionsTable" class="transactions-table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(0)">Origem <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable(1)">Destino <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable(2)">Valor <i class="fas fa-sort"></i></th>
                                    <th onclick="sortTable(3)">Data <i class="fas fa-sort"></i></th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- Dados ser√£o inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Legenda -->
            <div class="legend-container">
                <h4 style="margin-bottom: 15px; color: var(--primary-color);">
                    <i class="fas fa-info-circle"></i> Legenda Visual
                </h4>
                <div id="legendContent">
                    <!-- Conte√∫do ser√° gerado dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let cy = null;
        let currentData = null;
        let customizations = {};
        let entityTypes = [];
        let filteredTransactions = [];
        let selectedNode = null;
        
        // Configura√ß√£o de √≠cones por campo
        let fieldIconConfig = {
            source: 'fas fa-arrow-right',      // √çcone padr√£o para origem
            target: 'fas fa-bullseye',         // √çcone padr√£o para destino  
            both: 'fas fa-exchange-alt'        // √çcone padr√£o para ambos
        };

        // √çcones dispon√≠veis (organizados por categoria)
        const availableIcons = {
            'fas fa-user': 'Pessoa',
            'fas fa-building': 'Empresa', 
            'fas fa-home': 'Casa/Endere√ßo',
            'fas fa-credit-card': 'Cart√£o',
            'fas fa-money-bill': 'Dinheiro',
            'fas fa-phone': 'Telefone',
            'fas fa-envelope': 'Email',
            'fas fa-mask': 'Suspeito/Ladr√£o',
            'fas fa-university': 'Banco',
            'fas fa-car': 'Ve√≠culo',
            'fas fa-map-marker-alt': 'Localiza√ß√£o',
            'fas fa-briefcase': 'Neg√≥cio',
            'fas fa-shield-alt': 'Seguran√ßa',
            'fas fa-exclamation-triangle': 'Alerta',
            'fas fa-cash-register': 'Caixa Eletr√¥nico',
            'fas fa-calculator': 'M√°quina POS',
            'fas fa-arrow-right': 'Seta Direita',
            'fas fa-bullseye': 'Alvo',
            'fas fa-exchange-alt': 'Troca'
        };

        // Cores dispon√≠veis
        const availableColors = [
            '#dc2626', '#ea580c', '#7c3aed', '#eab308', '#2563eb', 
            '#60a5fa', '#059669', '#6b7280', '#f59e0b', '#8b5cf6',
            '#ef4444', '#10b981', '#3b82f6', '#f97316', '#84cc16'
        ];

        // Fun√ß√£o para mostrar toast
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, duration);
        }

        // Fun√ß√µes de drag and drop
        function handleDragOver(event) {
            event.preventDefault();
            document.getElementById('uploadArea').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            document.getElementById('uploadArea').classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            document.getElementById('uploadArea').classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            processFile(file);
        }

        // Fun√ß√£o para processar arquivo
        function processFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xml')) {
                showToast('‚ùå Formato n√£o suportado! Use CSV, Excel (.xlsx) ou XML', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (fileName.endsWith('.csv')) {
                        currentData = parseCSV(e.target.result);
                    } else if (fileName.endsWith('.xlsx')) {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        currentData = XLSX.utils.sheet_to_json(worksheet);
                    } else if (fileName.endsWith('.xml')) {
                        currentData = parseXML(e.target.result);
                    }
                    
                    if (currentData && currentData.length > 0) {
                        showToast(`‚úÖ Arquivo ${file.name} carregado: ${currentData.length} registros`, 'success');
                        showFieldSelector();
                    } else {
                        showToast('‚ö†Ô∏è Nenhum dado encontrado no arquivo', 'warning');
                    }
                } catch (error) {
                    showToast('‚ùå Erro ao carregar arquivo: ' + error.message, 'error');
                    console.error(error);
                }
            };
            
            if (fileName.endsWith('.csv') || fileName.endsWith('.xml')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // Fun√ß√£o para parsear CSV
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }

        // Fun√ß√£o para parsear XML
        function parseXML(xmlText) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const parserError = xmlDoc.getElementsByTagName('parsererror');
                if (parserError.length > 0) {
                    throw new Error('XML mal formado');
                }
                
                const data = [];
                let records = [];
                
                records = xmlDoc.getElementsByTagName('record');
                if (records.length === 0) records = xmlDoc.getElementsByTagName('item');
                if (records.length === 0) records = xmlDoc.getElementsByTagName('row');
                if (records.length === 0) records = xmlDoc.getElementsByTagName('data');
                if (records.length === 0) {
                    const root = xmlDoc.documentElement;
                    if (root && root.children.length > 0) {
                        records = root.children;
                    }
                }
                
                for (let i = 0; i < records.length; i++) {
                    const record = records[i];
                    const obj = {};
                    
                    if (record.attributes) {
                        for (let j = 0; j < record.attributes.length; j++) {
                            const attr = record.attributes[j];
                            obj[attr.name] = attr.value;
                        }
                    }
                    
                    if (record.children) {
                        for (let j = 0; j < record.children.length; j++) {
                            const child = record.children[j];
                            obj[child.tagName] = child.textContent || child.innerText || '';
                        }
                    }
                    
                    if (Object.keys(obj).length === 0 && record.textContent) {
                        obj['content'] = record.textContent;
                        obj['tag'] = record.tagName;
                    }
                    
                    if (Object.keys(obj).length > 0) {
                        data.push(obj);
                    }
                }
                
                if (data.length === 0) {
                    throw new Error('Nenhum dado encontrado no XML.');
                }
                
                return data;
                
            } catch (error) {
                console.error('Erro ao parsear XML:', error);
                throw new Error('Erro ao processar XML: ' + error.message);
            }
        }

        // Fun√ß√£o para mostrar seletor de campos
        function showFieldSelector() {
            if (!currentData || currentData.length === 0) return;
            
            const firstRow = currentData[0];
            const columns = Object.keys(firstRow);
            
            const sourceField = document.getElementById('sourceField');
            const targetField = document.getElementById('targetField');
            const valueField = document.getElementById('valueField');
            
            [sourceField, targetField, valueField].forEach(select => {
                select.innerHTML = '<option value="">Selecione...</option>';
                columns.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    select.appendChild(option);
                });
            });
            
            autoSelectFields(columns);
            document.getElementById('fieldSelector').style.display = 'block';
            updateFieldHint(columns);
            
            [sourceField, targetField, valueField].forEach(select => {
                select.addEventListener('change', () => updateFieldHint(columns));
            });
        }

        function autoSelectFields(columns) {
            const sourceField = document.getElementById('sourceField');
            const targetField = document.getElementById('targetField');
            const valueField = document.getElementById('valueField');
            
            for (const col of columns) {
                const colLower = col.toLowerCase();
                
                if (!sourceField.value && (colLower.includes('origem') || colLower.includes('source') || colLower.includes('from') || colLower.includes('de'))) {
                    sourceField.value = col;
                }
                
                if (!targetField.value && (colLower.includes('destino') || colLower.includes('target') || colLower.includes('to') || colLower.includes('para'))) {
                    targetField.value = col;
                }
                
                if (!valueField.value && (colLower.includes('valor') || colLower.includes('value') || colLower.includes('amount') || colLower.includes('quantia'))) {
                    valueField.value = col;
                }
            }
            
            if (!sourceField.value && columns.length > 0) sourceField.value = columns[0];
            if (!targetField.value && columns.length > 1) targetField.value = columns[1];
            if (!valueField.value && columns.length > 2) valueField.value = columns[2];
        }

        function updateFieldHint(columns) {
            const selectedFields = getSelectedFields();
            let hint = `${columns.length} colunas detectadas: ${columns.join(', ')}`;
            
            if (selectedFields.source && selectedFields.target) {
                hint += `<br><strong>‚úÖ Configura√ß√£o v√°lida:</strong> ${selectedFields.source} ‚Üí ${selectedFields.target}`;
                if (selectedFields.value) {
                    hint += ` (${selectedFields.value})`;
                }
            } else {
                hint += `<br><strong>‚ö†Ô∏è Selecione pelo menos Origem e Destino</strong>`;
            }
            
            document.getElementById('fieldHint').innerHTML = hint;
        }

        function getSelectedFields() {
            return {
                source: document.getElementById('sourceField').value,
                target: document.getElementById('targetField').value,
                value: document.getElementById('valueField').value
            };
        }

        // Fun√ß√£o para gerar interface de customiza√ß√£o por campo
        function generateFieldCustomizationInterface() {
            const customizationContent = document.getElementById('customizationInner');
            
            const iconOptions = Object.entries(availableIcons).map(([iconClass, iconName]) => `
                <div class="icon-option" onclick="selectFieldIcon('source', '${iconClass}')" title="${iconName}">
                    ${iconClass === 'fas fa-calculator' ? '<div class="pos-icon"><div class="keypad"></div><div class="color-buttons"></div></div>' : `<i class="${iconClass}"></i>`}
                </div>
            `).join('');
            
            const iconOptionsTarget = Object.entries(availableIcons).map(([iconClass, iconName]) => `
                <div class="icon-option" onclick="selectFieldIcon('target', '${iconClass}')" title="${iconName}">
                    ${iconClass === 'fas fa-calculator' ? '<div class="pos-icon"><div class="keypad"></div><div class="color-buttons"></div></div>' : `<i class="${iconClass}"></i>`}
                </div>
            `).join('');
            
            const iconOptionsBoth = Object.entries(availableIcons).map(([iconClass, iconName]) => `
                <div class="icon-option" onclick="selectFieldIcon('both', '${iconClass}')" title="${iconName}">
                    ${iconClass === 'fas fa-calculator' ? '<div class="pos-icon"><div class="keypad"></div><div class="color-buttons"></div></div>' : `<i class="${iconClass}"></i>`}
                </div>
            `).join('');
            
            customizationContent.innerHTML = `
                <div class="customization-grid">
                    <div class="icon-selector">
                        <h5 style="margin-bottom: 15px; color: #fbbf24;">
                            <i class="fas fa-arrow-right"></i> √çcone para Campo ORIGEM
                        </h5>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">
                            Ser√° aplicado a todas as entidades que aparecem como origem
                        </p>
                        <div class="icon-grid">
                            ${iconOptions}
                        </div>
                    </div>
                    
                    <div class="icon-selector">
                        <h5 style="margin-bottom: 15px; color: #fbbf24;">
                            <i class="fas fa-bullseye"></i> √çcone para Campo DESTINO
                        </h5>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">
                            Ser√° aplicado a todas as entidades que aparecem como destino
                        </p>
                        <div class="icon-grid">
                            ${iconOptionsTarget}
                        </div>
                    </div>
                    
                    <div class="icon-selector">
                        <h5 style="margin-bottom: 15px; color: #fbbf24;">
                            <i class="fas fa-exchange-alt"></i> √çcone para AMBOS (Origem e Destino)
                        </h5>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">
                            Para entidades que aparecem tanto como origem quanto destino
                        </p>
                        <div class="icon-grid">
                            ${iconOptionsBoth}
                        </div>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para mostrar painel de customiza√ß√£o
        function showCustomizationPanel() {
            const selectedFields = getSelectedFields();
            
            if (!selectedFields.source || !selectedFields.target) {
                showToast('‚ö†Ô∏è Selecione pelo menos os campos de Origem e Destino', 'warning');
                return;
            }
            
            if (!currentData || currentData.length === 0) {
                showToast('‚ö†Ô∏è Nenhum dado carregado!', 'warning');
                return;
            }
            
            // Gerar interface de customiza√ß√£o por campo
            generateFieldCustomizationInterface();
            
            document.getElementById('customizationPanel').style.display = 'block';
            showToast('üé® Painel de customiza√ß√£o por campo aberto!', 'info');
        }

        // Fun√ß√£o para identificar tipos de entidades
        function identifyEntityTypes() {
            const selectedFields = getSelectedFields();
            const entities = new Set();
            
            currentData.forEach(row => {
                const source = row[selectedFields.source];
                const target = row[selectedFields.target];
                if (source) entities.add(source);
                if (target) entities.add(target);
            });
            
            entityTypes = Array.from(entities).sort();
            
            // Inicializar customiza√ß√µes padr√£o
            entityTypes.forEach(entity => {
                if (!customizations[entity]) {
                    customizations[entity] = {
                        icon: 'fas fa-circle',
                        color: '#2563eb'
                    };
                }
            });
        }

        // Fun√ß√£o para gerar interface de customiza√ß√£o
        function generateCustomizationInterface() {
            const content = document.getElementById('customizationContent');
            content.innerHTML = '';
            
            entityTypes.forEach((entity, index) => {
                const entityDiv = document.createElement('div');
                entityDiv.className = 'customization-grid';
                entityDiv.style.marginBottom = '20px';
                entityDiv.style.padding = '15px';
                entityDiv.style.background = 'rgba(255, 255, 255, 0.1)';
                entityDiv.style.borderRadius = '8px';
                
                entityDiv.innerHTML = `
                    <div>
                        <h5 style="margin-bottom: 15px; color: #fbbf24;">
                            <i class="fas fa-tag"></i> ${entity}
                        </h5>
                        
                        <div class="icon-selector">
                            <h6 style="margin-bottom: 10px;">Escolha um √çcone:</h6>
                            <div class="icon-grid">
                                ${Object.entries(availableIcons).map(([iconClass, iconName]) => `
                                    <div class="icon-option ${customizations[entity].icon === iconClass ? 'selected' : ''}" 
                                         onclick="selectIcon('${entity}', '${iconClass}')" 
                                         title="${iconName}">
                                        ${iconClass === 'fas fa-calculator' ? '<div class="pos-icon"><div class="keypad"></div><div class="color-buttons"></div></div>' : `<i class="${iconClass}"></i>`}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="color-selector" style="margin-top: 15px;">
                            <h6 style="margin-bottom: 10px;">Escolha uma Cor:</h6>
                            <div class="color-grid">
                                ${availableColors.map(color => `
                                    <div class="color-option ${customizations[entity].color === color ? 'selected' : ''}" 
                                         style="background-color: ${color};" 
                                         onclick="selectColor('${entity}', '${color}')">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                content.appendChild(entityDiv);
            });
        }

        // Fun√ß√£o para selecionar √≠cone
        function selectIcon(entity, iconClass) {
            customizations[entity].icon = iconClass;
            
            // Atualizar interface
            const entityDiv = event.target.closest('.customization-grid');
            entityDiv.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.icon-option').classList.add('selected');
            
            showToast(`√çcone atualizado para ${entity}`, 'success', 2000);
        }

        // Fun√ß√£o para selecionar cor
        function selectColor(entity, color) {
            customizations[entity].color = color;
            
            // Atualizar interface
            const entityDiv = event.target.closest('.customization-grid');
            entityDiv.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');
            
            showToast(`Cor atualizada para ${entity}`, 'success', 2000);
        }

        // Fun√ß√£o para converter √≠cones FontAwesome em c√≥digos Unicode espec√≠ficos
        function getIconText(iconClass) {
            const iconMap = {
                'fas fa-user': 'üë§',               // Pessoa
                'fas fa-building': 'üè¢',           // Empresa
                'fas fa-home': 'üè†',               // Casa
                'fas fa-credit-card': 'üí≥',        // Cart√£o
                'fas fa-money-bill': 'üí∞',         // Dinheiro
                'fas fa-phone': 'üìû',              // Telefone
                'fas fa-envelope': 'üìß',           // Email
                'fas fa-mask': 'üé≠',               // M√°scara
                'fas fa-university': 'üèõÔ∏è',         // Banco
                'fas fa-car': 'üöó',                // Carro
                'fas fa-map-marker-alt': 'üìç',     // Localiza√ß√£o
                'fas fa-briefcase': 'üíº',          // Neg√≥cio
                'fas fa-shield-alt': 'üõ°Ô∏è',         // Seguran√ßa
                'fas fa-exclamation-triangle': '‚ö†Ô∏è', // Alerta
                'fas fa-cash-register': 'üèß',      // Caixa Eletr√¥nico
                'fas fa-calculator': 'üì±',         // Point/POS (M√°quina POS)
                'fas fa-arrow-right': '‚û°Ô∏è',        // Seta
                'fas fa-bullseye': 'üéØ',           // Alvo
                'fas fa-exchange-alt': 'üîÑ'        // Troca
            };
            return iconMap[iconClass] || '‚óè';
        }

        // Fun√ß√£o para renderizar √≠cones HTML (para pain√©is)
        function getIconHTML(iconClass) {
            if (iconClass === 'fas fa-calculator') {
                return '<div class="pos-icon"><div class="keypad"></div><div class="color-buttons"></div></div>';
            }
            return getIconText(iconClass);
        }

        // Fun√ß√£o para converter √≠cones FontAwesome em emojis (para legenda)
        function getIconUnicode(iconClass) {
            const iconMap = {
                'fas fa-user': 'üë§',
                'fas fa-building': 'üè¢',
                'fas fa-home': 'üè†',
                'fas fa-credit-card': 'üí≥',
                'fas fa-money-bill': 'üí∞',
                'fas fa-phone': 'üìû',
                'fas fa-envelope': 'üìß',
                'fas fa-mask': 'üé≠',
                'fas fa-university': 'üèõÔ∏è',
                'fas fa-car': 'üöó',
                'fas fa-map-marker-alt': 'üìç',
                'fas fa-briefcase': 'üíº',
                'fas fa-shield-alt': 'üõ°Ô∏è',
                'fas fa-exclamation-triangle': '‚ö†Ô∏è',
                'fas fa-cash-register': 'üèß',
                'fas fa-calculator': 'üì±',
                'fas fa-arrow-right': '‚û°Ô∏è',
                'fas fa-bullseye': 'üéØ',
                'fas fa-exchange-alt': 'üîÑ'
            };
            return iconMap[iconClass] || '‚ö™';
        }

        // Fun√ß√£o para determinar tipo de n√≥ por valor (sistema de cores)
        function getNodeTypeByValue(value) {
            const numValue = parseFloat(String(value).replace(/[^\d.-]/g, '')) || 0;
            
            if (numValue >= 1000000) {
                return { 
                    color: '#dc2626', 
                    size: 120, 
                    shadow: '0 0 30px rgba(220, 38, 38, 0.6)',
                    type: 'Ultra Alto (‚â•R$ 1M)'
                };
            } else if (numValue >= 500000) {
                return { 
                    color: '#ea580c', 
                    size: 110, 
                    shadow: '0 0 25px rgba(234, 88, 12, 0.5)',
                    type: 'Muito Alto (‚â•R$ 500K)'
                };
            } else if (numValue >= 250000) {
                return { 
                    color: '#7c3aed', 
                    size: 100, 
                    shadow: '0 0 20px rgba(124, 58, 237, 0.4)',
                    type: 'Roxo Alto (‚â•R$ 250K)'
                };
            } else if (numValue >= 100000) {
                return { 
                    color: '#eab308', 
                    size: 90, 
                    shadow: 'none',
                    type: 'Alto (‚â•R$ 100K)'
                };
            } else if (numValue >= 50000) {
                return { 
                    color: '#2563eb', 
                    size: 80, 
                    shadow: 'none',
                    type: 'M√©dio (‚â•R$ 50K)'
                };
            } else if (numValue >= 10000) {
                return { 
                    color: '#60a5fa', 
                    size: 70, 
                    shadow: 'none',
                    type: 'M√©dio-Baixo (‚â•R$ 10K)'
                };
            } else {
                return { 
                    color: '#059669', 
                    size: 60, 
                    shadow: 'none',
                    type: 'Baixo (<R$ 10K)'
                };
            }
        }

        // Fun√ß√£o para selecionar √≠cone por campo
        function selectFieldIcon(fieldType, iconClass) {
            fieldIconConfig[fieldType] = iconClass;
            
            // Atualizar visual da sele√ß√£o
            document.querySelectorAll(`.icon-selector .icon-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            
            const fieldNames = {
                'source': 'ORIGEM',
                'target': 'DESTINO', 
                'both': 'AMBOS (Origem e Destino)'
            };
            
            showToast(`‚úÖ √çcone ${availableIcons[iconClass]} selecionado para campo ${fieldNames[fieldType]}`, 'success', 3000);
        }

        // Fun√ß√£o para resetar customiza√ß√£o
        function resetCustomization() {
            fieldIconConfig = {
                source: 'fas fa-arrow-right',
                target: 'fas fa-bullseye', 
                both: 'fas fa-exchange-alt'
            };
            
            document.querySelectorAll('.icon-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            showToast('üîÑ Customiza√ß√µes resetadas', 'info');
        }

        // Fun√ß√£o para exportar grafo
        function exportGraph(format) {
            if (!cy) {
                showToast('‚ùå Nenhum grafo carregado para exportar', 'error', 3000);
                return;
            }

            try {
                if (format === 'png') {
                    const png64 = cy.png({
                        output: 'base64uri',
                        bg: '#ffffff',
                        full: true,
                        scale: 2
                    });
                    
                    const link = document.createElement('a');
                    link.href = png64;
                    link.download = 'grafo_investigativo.png';
                    link.click();
                    
                    showToast('‚úÖ Grafo exportado como PNG com sucesso!', 'success', 3000);
                } else if (format === 'json') {
                    const data = cy.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'grafo_investigativo.json';
                    link.click();
                    
                    URL.revokeObjectURL(url);
                    showToast('‚úÖ Dados do grafo exportados como JSON!', 'success', 3000);
                }
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showToast('‚ùå Erro ao exportar grafo', 'error', 3000);
            }
        }

        // Fun√ß√£o para aplicar filtro por valor
        function applyValueFilter() {
            if (!cy) {
                showToast('‚ùå Nenhum grafo carregado para filtrar', 'error', 3000);
                return;
            }

            const minValue = parseFloat(document.getElementById('minValue').value) || 0;
            
            cy.edges().forEach(edge => {
                const edgeValue = parseFloat(edge.data('value')) || 0;
                if (edgeValue >= minValue) {
                    edge.style('display', 'element');
                } else {
                    edge.style('display', 'none');
                }
            });

            // Ocultar n√≥s que n√£o t√™m conex√µes vis√≠veis
            cy.nodes().forEach(node => {
                const visibleEdges = node.connectedEdges().filter(edge => edge.style('display') === 'element');
                if (visibleEdges.length === 0) {
                    node.style('display', 'none');
                } else {
                    node.style('display', 'element');
                }
            });

            showToast(`‚úÖ Filtro aplicado! Valores ‚â• R$ ${minValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 'success', 3000);
        }

        // Fun√ß√£o para mostrar painel de transa√ß√µes
        function showTransactionsPanel() {
            if (!currentData || currentData.length === 0) {
                showToast('‚ùå Nenhum dado carregado para exibir transa√ß√µes', 'error', 3000);
                return;
            }

            document.getElementById('transactionsPanel').style.display = 'block';
            populateTransactionsTable();
            showToast('üìä Painel de transa√ß√µes exibido', 'success', 2000);
        }

        // Fun√ß√£o para popular a tabela de transa√ß√µes
        function populateTransactionsTable() {
            const selectedFields = getSelectedFields();
            filteredTransactions = currentData.slice(); // C√≥pia dos dados
            
            updateTransactionsStats();
            renderTransactionsTable();
        }

        // Fun√ß√£o para atualizar estat√≠sticas
        function updateTransactionsStats() {
            const totalTransactions = filteredTransactions.length;
            const totalValue = filteredTransactions.reduce((sum, row) => {
                const value = parseFloat(String(row[getSelectedFields().value] || 0).replace(/[^\d.-]/g, '')) || 0;
                return sum + value;
            }, 0);
            
            const avgValue = totalValue / totalTransactions || 0;
            const uniqueEntities = new Set();
            
            filteredTransactions.forEach(row => {
                const fields = getSelectedFields();
                if (row[fields.source]) uniqueEntities.add(row[fields.source]);
                if (row[fields.target]) uniqueEntities.add(row[fields.target]);
            });

            const statsContainer = document.getElementById('transactionsStats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h5>Total de Transa√ß√µes</h5>
                    <p>${totalTransactions.toLocaleString('pt-BR')}</p>
                </div>
                <div class="stat-card">
                    <h5>Valor Total</h5>
                    <p>${totalValue.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</p>
                </div>
                <div class="stat-card">
                    <h5>Valor M√©dio</h5>
                    <p>${avgValue.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</p>
                </div>
                <div class="stat-card">
                    <h5>Entidades √önicas</h5>
                    <p>${uniqueEntities.size}</p>
                </div>
            `;
        }

        // Fun√ß√£o para renderizar tabela de transa√ß√µes
        function renderTransactionsTable() {
            const tbody = document.getElementById('transactionsTableBody');
            const selectedFields = getSelectedFields();
            
            tbody.innerHTML = '';
            
            filteredTransactions.forEach((row, index) => {
                const source = row[selectedFields.source] || '';
                const target = row[selectedFields.target] || '';
                const value = parseFloat(String(row[selectedFields.value] || 0).replace(/[^\d.-]/g, '')) || 0;
                const date = row['Data'] || row['data'] || row['DATE'] || 'N/A';
                
                let valueClass = 'transaction-value';
                if (value >= 100000) valueClass += ' high';
                else if (value >= 10000) valueClass += ' medium';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${source}</td>
                    <td>${target}</td>
                    <td class="${valueClass}">${value.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                    <td>${date}</td>
                    <td>
                        <button class="action-btn" onclick="highlightTransaction('${source}', '${target}')">
                            <i class="fas fa-search"></i> Destacar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Fun√ß√£o para filtrar transa√ß√µes
        function filterTransactions() {
            const selectedFields = getSelectedFields();
            const originFilter = document.getElementById('filterOrigin').value.toLowerCase();
            const targetFilter = document.getElementById('filterTarget').value.toLowerCase();
            const minValue = parseFloat(document.getElementById('filterMinValue').value) || 0;
            const maxValue = parseFloat(document.getElementById('filterMaxValue').value) || Infinity;
            
            filteredTransactions = currentData.filter(row => {
                const source = String(row[selectedFields.source] || '').toLowerCase();
                const target = String(row[selectedFields.target] || '').toLowerCase();
                const value = parseFloat(String(row[selectedFields.value] || 0).replace(/[^\d.-]/g, '')) || 0;
                
                return source.includes(originFilter) &&
                       target.includes(targetFilter) &&
                       value >= minValue &&
                       value <= maxValue;
            });
            
            updateTransactionsStats();
            renderTransactionsTable();
        }

        // Fun√ß√£o para limpar filtros
        function clearFilters() {
            document.getElementById('filterOrigin').value = '';
            document.getElementById('filterTarget').value = '';
            document.getElementById('filterMinValue').value = '';
            document.getElementById('filterMaxValue').value = '';
            
            filteredTransactions = currentData.slice();
            updateTransactionsStats();
            renderTransactionsTable();
            
            showToast('üßπ Filtros limpos', 'info', 2000);
        }

        // Fun√ß√£o para exportar transa√ß√µes
        function exportTransactions(format) {
            if (!filteredTransactions || filteredTransactions.length === 0) {
                showToast('‚ùå Nenhuma transa√ß√£o para exportar', 'error', 3000);
                return;
            }

            if (format === 'csv') {
                const selectedFields = getSelectedFields();
                const headers = [selectedFields.source, selectedFields.target, selectedFields.value, 'Data'];
                const csvContent = [
                    headers.join(','),
                    ...filteredTransactions.map(row => [
                        `"${row[selectedFields.source] || ''}"`,
                        `"${row[selectedFields.target] || ''}"`,
                        `"${row[selectedFields.value] || ''}"`,
                        `"${row['Data'] || row['data'] || row['DATE'] || ''}"`
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'transacoes_filtradas.csv';
                link.click();
                
                showToast('‚úÖ Transa√ß√µes exportadas com sucesso!', 'success', 3000);
            }
        }

        // Fun√ß√£o para destacar transa√ß√£o no grafo
        function highlightTransaction(source, target) {
            if (!cy) return;
            
            // Reset previous highlights
            cy.elements().removeClass('highlighted');
            
            // Highlight nodes
            cy.nodes().forEach(node => {
                if (node.data('label') === source || node.data('label') === target) {
                    node.addClass('highlighted');
                }
            });
            
            // Highlight edge
            cy.edges().forEach(edge => {
                if (edge.data('source') === source && edge.data('target') === target) {
                    edge.addClass('highlighted');
                }
            });
            
            showToast(`üéØ Transa√ß√£o ${source} ‚Üí ${target} destacada no grafo`, 'info', 3000);
        }

        // Fun√ß√£o para otimizar grafo com IA
        function optimizeGraphWithAI() {
            if (!cy) {
                showToast('‚ùå Nenhum grafo carregado para otimizar', 'error', 3000);
                return;
            }

            showToast('üß† Otimizando grafo com IA...', 'info', 2000);
            
            // Simular an√°lise de IA
            setTimeout(() => {
                // Aplicar layout otimizado baseado em centralidade
                const nodes = cy.nodes();
                const nodeMetrics = [];
                
                nodes.forEach(node => {
                    const degree = node.degree();
                    const totalValue = node.data('numericValue') || 0;
                    const centrality = degree * Math.log(totalValue + 1);
                    
                    nodeMetrics.push({
                        node: node,
                        centrality: centrality,
                        degree: degree,
                        value: totalValue
                    });
                });
                
                // Ordenar por centralidade
                nodeMetrics.sort((a, b) => b.centrality - a.centrality);
                
                // Aplicar layout conc√™ntrico baseado na import√¢ncia
                cy.layout({
                    name: 'concentric',
                    concentric: function(node) {
                        const metric = nodeMetrics.find(m => m.node.id() === node.id());
                        return metric ? metric.centrality : 0;
                    },
                    levelWidth: function() {
                        return 2;
                    },
                    animate: true,
                    animationDuration: 1000
                }).run();
                
                showToast('‚úÖ Grafo otimizado com IA! N√≥s organizados por import√¢ncia', 'success', 4000);
            }, 1500);
        }

        // Fun√ß√£o para an√°lise detalhada com IA
        function analyzeWithAI() {
            if (!currentData || currentData.length === 0) {
                showToast('‚ùå Nenhum dado carregado para an√°lise', 'error', 3000);
                return;
            }

            showToast('üîç Realizando an√°lise detalhada com IA...', 'info', 2000);
            
            setTimeout(() => {
                const analysis = performAIAnalysis();
                displayAIAnalysis(analysis);
                showToast('‚úÖ An√°lise com IA conclu√≠da!', 'success', 3000);
            }, 2000);
        }

        // Fun√ß√£o para realizar an√°lise de IA
        function performAIAnalysis() {
            const selectedFields = getSelectedFields();
            const entities = new Map();
            const transactions = [];
            
            // Coletar dados para an√°lise
            currentData.forEach(row => {
                const source = row[selectedFields.source];
                const target = row[selectedFields.target];
                const value = parseFloat(String(row[selectedFields.value] || 0).replace(/[^\d.-]/g, '')) || 0;
                
                if (source && target && value > 0) {
                    // Atualizar estat√≠sticas das entidades
                    if (!entities.has(source)) {
                        entities.set(source, { totalValue: 0, transactions: 0, connections: new Set() });
                    }
                    if (!entities.has(target)) {
                        entities.set(target, { totalValue: 0, transactions: 0, connections: new Set() });
                    }
                    
                    entities.get(source).totalValue += value;
                    entities.get(source).transactions += 1;
                    entities.get(source).connections.add(target);
                    
                    entities.get(target).totalValue += value;
                    entities.get(target).transactions += 1;
                    entities.get(target).connections.add(source);
                    
                    transactions.push({ source, target, value });
                }
            });
            
            // An√°lise de padr√µes suspeitos
            const suspiciousPatterns = [];
            const highValueEntities = [];
            const hubEntities = [];
            
            entities.forEach((data, entity) => {
                // Entidades com alto volume
                if (data.totalValue > 500000) {
                    highValueEntities.push({ entity, value: data.totalValue });
                }
                
                // Entidades hub (muitas conex√µes)
                if (data.connections.size > 5) {
                    hubEntities.push({ entity, connections: data.connections.size });
                }
                
                // Padr√µes suspeitos
                if (data.totalValue > 1000000 && data.transactions < 3) {
                    suspiciousPatterns.push({
                        type: 'Alto valor, poucas transa√ß√µes',
                        entity: entity,
                        description: `${entity} movimentou ${data.totalValue.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} em apenas ${data.transactions} transa√ß√µes`
                    });
                }
            });
            
            return {
                totalEntities: entities.size,
                totalTransactions: transactions.length,
                highValueEntities: highValueEntities.sort((a, b) => b.value - a.value).slice(0, 5),
                hubEntities: hubEntities.sort((a, b) => b.connections - a.connections).slice(0, 5),
                suspiciousPatterns: suspiciousPatterns,
                recommendations: generateRecommendations(entities, transactions)
            };
        }

        // Fun√ß√£o para gerar recomenda√ß√µes
        function generateRecommendations(entities, transactions) {
            const recommendations = [];
            
            // Recomenda√ß√£o baseada em centralidade
            const centralEntities = Array.from(entities.entries())
                .sort((a, b) => b[1].connections.size - a[1].connections.size)
                .slice(0, 3);
                
            if (centralEntities.length > 0) {
                recommendations.push({
                    type: 'Investiga√ß√£o Priorit√°ria',
                    description: `Focar investiga√ß√£o em: ${centralEntities.map(e => e[0]).join(', ')} - entidades com maior n√∫mero de conex√µes`
                });
            }
            
            // Recomenda√ß√£o baseada em valores
            const highValueTransactions = transactions
                .filter(t => t.value > 100000)
                .length;
                
            if (highValueTransactions > 0) {
                recommendations.push({
                    type: 'Monitoramento Especial',
                    description: `${highValueTransactions} transa√ß√µes acima de R$ 100.000 identificadas - requerem aten√ß√£o especial`
                });
            }
            
            return recommendations;
        }

        // Fun√ß√£o para exibir an√°lise de IA
        function displayAIAnalysis(analysis) {
            // Criar painel de an√°lise se n√£o existir
            let analysisPanel = document.getElementById('aiAnalysisPanel');
            if (!analysisPanel) {
                analysisPanel = document.createElement('div');
                analysisPanel.id = 'aiAnalysisPanel';
                analysisPanel.className = 'ai-analysis-panel';
                document.querySelector('.main-content').appendChild(analysisPanel);
            }
            
            analysisPanel.innerHTML = `
                <h4 style="margin-bottom: 20px;">
                    <i class="fas fa-brain"></i> An√°lise Detalhada com IA
                </h4>
                
                <div class="ai-insight">
                    <h6>üìä Resumo Geral</h6>
                    <p>Foram analisadas ${analysis.totalEntities} entidades e ${analysis.totalTransactions} transa√ß√µes.</p>
                </div>
                
                <div class="ai-insight">
                    <h6>üí∞ Entidades de Alto Valor</h6>
                    <p>${analysis.highValueEntities.length > 0 ? 
                        analysis.highValueEntities.map(e => 
                            `${e.entity}: ${e.value.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`
                        ).join('<br>') : 
                        'Nenhuma entidade com alto valor identificada.'}</p>
                </div>
                
                <div class="ai-insight">
                    <h6>üï∏Ô∏è Entidades Hub (Muitas Conex√µes)</h6>
                    <p>${analysis.hubEntities.length > 0 ? 
                        analysis.hubEntities.map(e => 
                            `${e.entity}: ${e.connections} conex√µes`
                        ).join('<br>') : 
                        'Nenhuma entidade hub identificada.'}</p>
                </div>
                
                <div class="ai-insight">
                    <h6>‚ö†Ô∏è Padr√µes Suspeitos</h6>
                    <p>${analysis.suspiciousPatterns.length > 0 ? 
                        analysis.suspiciousPatterns.map(p => 
                            `<strong>${p.type}:</strong> ${p.description}`
                        ).join('<br>') : 
                        'Nenhum padr√£o suspeito identificado.'}</p>
                </div>
                
                <div class="ai-insight">
                    <h6>üí° Recomenda√ß√µes</h6>
                    <p>${analysis.recommendations.map(r => 
                        `<strong>${r.type}:</strong> ${r.description}`
                    ).join('<br>')}</p>
                </div>
            `;
            
            analysisPanel.style.display = 'block';
        }

        // Fun√ß√£o para focar em n√≥ selecionado
        function focusOnNode() {
            if (!cy || !selectedNode) {
                showToast('‚ùå Selecione um n√≥ no grafo primeiro', 'warning', 3000);
                return;
            }
            
            cy.animate({
                center: { eles: selectedNode },
                zoom: 2
            }, {
                duration: 1000
            });
            
            showToast(`üéØ Focalizando em: ${selectedNode.data('label')}`, 'info', 2000);
        }

        // Fun√ß√£o para exibir informa√ß√µes detalhadas do n√≥
        function showDetailedNodeInfo(nodeData) {
            // Criar ou atualizar painel de informa√ß√µes do n√≥
            let infoPanel = document.getElementById('nodeInfoPanel');
            if (!infoPanel) {
                infoPanel = document.createElement('div');
                infoPanel.id = 'nodeInfoPanel';
                infoPanel.className = 'node-info-panel';
                infoPanel.style.position = 'fixed';
                infoPanel.style.top = '20px';
                infoPanel.style.right = '20px';
                infoPanel.style.width = '300px';
                infoPanel.style.zIndex = '1000';
                document.body.appendChild(infoPanel);
            }
            
            const iconEmoji = getIconHTML(nodeData.customIcon);
            const nodeTypeColor = getNodeTypeByValue(nodeData.numericValue || 0);
            
            infoPanel.innerHTML = `
                <div style="background: linear-gradient(135deg, #1e293b, #334155); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #fbbf24;">
                            ${iconEmoji} ${nodeData.label}
                        </h4>
                        <button onclick="closeNodeInfo()" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">
                            √ó
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong>Tipo:</strong> ${nodeData.nodeType || 'N/A'}
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong>Conex√µes:</strong> ${nodeData.connections || 0}
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong>Volume Total:</strong> ${nodeData.totalValue || 'N/A'}
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong>Classifica√ß√£o:</strong> 
                        <span style="color: ${nodeTypeColor.color}; font-weight: bold;">
                            ${nodeTypeColor.type}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>√çcone:</strong> ${availableIcons[nodeData.customIcon] || 'Padr√£o'}
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button onclick="highlightConnections('${nodeData.id}')" class="action-btn" style="flex: 1; font-size: 0.85rem;">
                            <i class="fas fa-project-diagram"></i> Conex√µes
                        </button>
                        <button onclick="filterByEntity('${nodeData.label}')" class="action-btn" style="flex: 1; font-size: 0.85rem;">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        <button onclick="clearAllHighlights()" class="action-btn" style="flex: 0.8; font-size: 0.85rem; background: #dc2626;">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            `;
            
            infoPanel.style.display = 'block';
        }

        // Fun√ß√£o para fechar painel de informa√ß√µes do n√≥
        function closeNodeInfo() {
            const infoPanel = document.getElementById('nodeInfoPanel');
            if (infoPanel) {
                infoPanel.style.display = 'none';
            }
            
            // Remover destaque
            if (cy) {
                cy.nodes().removeClass('selected');
                // Manter conex√µes destacadas se existirem
            }
            selectedNode = null;
        }

        // Vari√°vel para controlar estado das conex√µes
        let currentHighlightedNode = null;
        
        // Vari√°veis para controle de conex√µes fortes
        let strongConnectionsActive = false;
        let originalElements = null;
        let strongConnectionsData = null;
        
        // Vari√°veis para controle de an√°lise otimizada
        let optimizedAnalysisActive = false;
        let originalElementsOptimized = null;
        let optimizedAnalysisData = null;

        // Fun√ß√£o para destacar conex√µes do n√≥ (com toggle)
        function highlightConnections(nodeId) {
            if (!cy) return;
            
            const node = cy.getElementById(nodeId);
            if (!node.length) return; // Verificar se o n√≥ existe
            
            // Se j√° est√° destacado, remover destaque (toggle off)
            if (currentHighlightedNode === nodeId) {
                // Limpar todos os highlights
                cy.elements().removeClass('highlighted connection-highlighted');
                cy.elements().removeStyle(); // Remove estilos inline
                
                // Reaplica estilos originais das conex√µes destacadas em preto mais claro
                cy.edges().style({
                    'line-color': '#404040', // Preto mais claro
                    'target-arrow-color': '#404040',
                    'width': 3
                });
                
                currentHighlightedNode = null;
                showToast(`üîó Conex√µes removidas`, 'info', 2000);
                return;
            }
            
            // Reset highlights anteriores
            cy.elements().removeClass('highlighted connection-highlighted');
            cy.elements().removeStyle(); // Remove estilos inline anteriores
            
            // Reaplica estilos padr√£o em preto mais claro
            cy.edges().style({
                'line-color': '#404040', // Preto mais claro
                'target-arrow-color': '#404040',
                'width': 3
            });
            
            const connectedEdges = node.connectedEdges();
            const connectedNodes = connectedEdges.connectedNodes();
            
            // Highlight node and its connections com classe especial
            node.addClass('highlighted');
            connectedEdges.addClass('connection-highlighted');
            connectedNodes.addClass('highlighted');
            
            // Aplicar estilos vermelhos √†s conex√µes destacadas
            connectedEdges.style({
                'line-color': '#dc2626',
                'target-arrow-color': '#dc2626',
                'width': 6
            });
            
            // Salvar estado atual
            currentHighlightedNode = nodeId;
            
            showToast(`üîó ${connectedEdges.length} conex√µes destacadas em vermelho`, 'success', 3000);
        }

        // Fun√ß√£o para limpar todos os highlights
        function clearAllHighlights() {
            if (!cy) return;
            
            // Remover todas as classes de destaque
            cy.elements().removeClass('highlighted connection-highlighted selected');
            cy.elements().removeStyle(); // Remove estilos inline
            
            // Reaplica estilos padr√£o das conex√µes em preto mais claro
            cy.edges().style({
                'line-color': '#404040', // Preto mais claro
                'target-arrow-color': '#404040',
                'width': 3
            });
            
            currentHighlightedNode = null;
            
            showToast(`üßπ Todos os destaques removidos`, 'info', 2000);
        }

        // Fun√ß√£o para toggle das conex√µes fortes
        function toggleStrongConnections() {
            if (!cy) {
                showToast('‚ö†Ô∏è Gere um grafo primeiro!', 'warning');
                return;
            }

            const btn = document.getElementById('strongConnectionsBtn');
            console.log('üîÑ Toggle chamado - Estado atual:', strongConnectionsActive);
            
            if (strongConnectionsActive) {
                console.log('üî¥ DESATIVANDO conex√µes fortes...');
                
                // Desativar: restaurar grafo original
                restoreOriginalGraph();
                
                // Reset completo das vari√°veis
                strongConnectionsActive = false;
                originalElements = null;
                strongConnectionsData = null;
                currentHighlightedNode = null;
                
                // Atualizar bot√£o
                btn.innerHTML = '<i class="fas fa-filter"></i> Mostrar Conex√µes Fortes';
                btn.style.background = 'linear-gradient(135deg, #dc2626, #b91c1c)';
                btn.disabled = false;
                
                console.log('‚úÖ DESATIVADO - Novo estado:', strongConnectionsActive);
                showToast('üìä Grafo original restaurado - Clique novamente para ativar', 'info', 3000);
                
            } else {
                console.log('üü¢ ATIVANDO conex√µes fortes...');
                
                // Limpar qualquer estado anterior antes de ativar
                clearAllHighlights();
                
                // Ativar: analisar e mostrar apenas conex√µes fortes
                analyzeAndShowStrongConnections();
                strongConnectionsActive = true;
                
                // Atualizar bot√£o
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Mostrar Todas Conex√µes';
                btn.style.background = 'linear-gradient(135deg, #059669, #047857)';
                btn.disabled = false;
                
                console.log('‚úÖ ATIVADO - Novo estado:', strongConnectionsActive);
                showToast('üî• Conex√µes fortes ativas - Clique novamente para desativar', 'success', 3000);
            }
            
            // Log final para verificar
            setTimeout(() => {
                console.log('üîç Estado final ap√≥s 500ms:', strongConnectionsActive);
            }, 500);
        }

        // Fun√ß√£o para analisar e mostrar apenas conex√µes fortes
        function analyzeAndShowStrongConnections() {
            if (!cy) return;
            
            console.log('üü¢ Iniciando an√°lise de conex√µes fortes...');

            // Salvar estado original completo (elementos e estilos) apenas se n√£o foi salvo ainda
            if (!originalElements) {
                originalElements = cy.elements().jsons();
                console.log('üíæ Estado original salvo');
            } else {
                console.log('üìã Estado original j√° existe, reutilizando');
            }
            
            // Limpar qualquer destaque anterior
            cy.elements().removeClass('highlighted connection-highlighted selected');
            cy.elements().removeStyle(); // Limpar estilos inline anteriores

            // Analisar valores das transa√ß√µes
            const edges = cy.edges();
            const edgeValues = [];

            edges.forEach(edge => {
                const label = edge.data('label');
                const numericValue = parseFloat(label.replace(/[^\d.-]/g, '')) || 0;
                edgeValues.push({
                    edge: edge,
                    value: numericValue,
                    id: edge.id()
                });
            });

            // Ordenar por valor e pegar percentil 75 (top 25%)
            edgeValues.sort((a, b) => b.value - a.value);
            const threshold = Math.ceil(edgeValues.length * 0.25); // Top 25%
            const strongEdges = edgeValues.slice(0, threshold);

            // Identificar n√≥s conectados √†s conex√µes fortes
            const strongNodes = new Set();
            strongEdges.forEach(item => {
                const edge = item.edge;
                strongNodes.add(edge.source().id());
                strongNodes.add(edge.target().id());
            });

            // Ocultar elementos fracos
            cy.elements().style('opacity', 0.1);
            cy.elements().style('z-index', 1);

            // Destacar conex√µes fortes
            strongEdges.forEach(item => {
                item.edge.style({
                    'opacity': 1,
                    'line-color': '#dc2626',
                    'target-arrow-color': '#dc2626',
                    'width': 8,
                    'z-index': 999
                });
            });

            // Destacar n√≥s das conex√µes fortes
            strongNodes.forEach(nodeId => {
                const node = cy.getElementById(nodeId);
                node.style({
                    'opacity': 1,
                    'border-width': 6,
                    'border-color': '#dc2626',
                    'z-index': 999,
                    'box-shadow': '0 0 20px #dc2626'
                });
            });

            // Aplicar layout otimizado para conex√µes fortes
            const strongElements = [];
            strongNodes.forEach(nodeId => {
                strongElements.push(cy.getElementById(nodeId));
            });
            strongEdges.forEach(item => {
                strongElements.push(item.edge);
            });

            // Reorganizar layout
            cy.layout({
                name: 'cose',
                animate: true,
                fit: true,
                padding: 50,
                nodeRepulsion: 8000,
                idealEdgeLength: 100,
                edgeElasticity: 200,
                nestingFactor: 1.2
            }).run();

            // Salvar dados das conex√µes fortes para estat√≠sticas
            strongConnectionsData = {
                totalConnections: edges.length,
                strongConnections: strongEdges.length,
                totalNodes: cy.nodes().length,
                strongNodes: strongNodes.size,
                averageStrongValue: strongEdges.reduce((sum, item) => sum + item.value, 0) / strongEdges.length,
                threshold: threshold
            };

            // Mostrar estat√≠sticas
            showStrongConnectionsStats();
            
            console.log('‚úÖ An√°lise de conex√µes fortes conclu√≠da');
            console.log(`üìä ${strongEdges.length} conex√µes fortes de ${edges.length} total`);
        }

        // Fun√ß√£o para restaurar grafo original
        function restoreOriginalGraph() {
            if (!cy) return;
            
            console.log('üîÑ Restaurando grafo original...');

            // Limpar todos os estilos inline aplicados
            cy.elements().removeStyle();
            cy.elements().removeClass('highlighted connection-highlighted selected');
            
            // Restaurar todos os elementos para visibilidade total
            cy.elements().style({
                'opacity': 1,
                'z-index': 1
            });
            
            // Aplicar estilos padr√£o das conex√µes em preto mais claro
            cy.edges().style({
                'line-color': '#404040', // Preto mais claro
                'target-arrow-color': '#404040',
                'width': 3,
                'opacity': 1,
                'z-index': 1
            });
            
            // Aplicar estilos padr√£o dos n√≥s
            cy.nodes().style({
                'opacity': 1,
                'border-width': 2,
                'border-color': '#1e40af',
                'z-index': 1,
                'box-shadow': 'none'
            });

            // Reorganizar layout para a vers√£o original
            cy.layout({
                name: 'cose',
                animate: true,
                fit: true,
                padding: 20,
                nodeRepulsion: 4000,
                idealEdgeLength: 50,
                edgeElasticity: 100,
                nestingFactor: 1
            }).run();

            // For√ßa a re-renderiza√ß√£o
            cy.forceRender();
            
            console.log('‚úÖ Grafo original restaurado completamente');
        }

        // Fun√ß√£o para mostrar estat√≠sticas das conex√µes fortes
        function showStrongConnectionsStats() {
            if (!strongConnectionsData) return;

            const stats = strongConnectionsData;
            showToast(`
                <strong>üìä An√°lise de Conex√µes Fortes</strong><br>
                üî• ${stats.strongConnections} de ${stats.totalConnections} conex√µes (${Math.round(stats.strongConnections/stats.totalConnections*100)}%)<br>
                üë• ${stats.strongNodes} de ${stats.totalNodes} entidades envolvidas<br>
                üí∞ Valor m√©dio: R$ ${stats.averageStrongValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
            `, 'info', 8000);
        }

        // ===== FUN√á√ïES PARA AN√ÅLISE OTIMIZADA =====

        // Fun√ß√£o para toggle da an√°lise otimizada
        function toggleOptimizedAnalysis() {
            if (!cy) {
                showToast('‚ö†Ô∏è Gere um grafo primeiro!', 'warning');
                return;
            }

            const btn = document.getElementById('optimizedAnalysisBtn');
            console.log('üîÑ Toggle An√°lise Otimizada - Estado atual:', optimizedAnalysisActive);
            
            if (optimizedAnalysisActive) {
                console.log('üî¥ DESATIVANDO an√°lise otimizada...');
                
                // Desativar: restaurar grafo original
                restoreOriginalGraphOptimized();
                
                // Reset completo das vari√°veis
                optimizedAnalysisActive = false;
                originalElementsOptimized = null;
                optimizedAnalysisData = null;
                currentHighlightedNode = null;
                
                // Atualizar bot√£o
                btn.innerHTML = '<i class="fas fa-bullseye"></i> Otimizar An√°lise';
                btn.style.background = 'linear-gradient(135deg, #7c3aed, #5b21b6)';
                btn.disabled = false;
                
                console.log('‚úÖ DESATIVADO - Novo estado:', optimizedAnalysisActive);
                showToast('üìä An√°lise original restaurada - Clique novamente para otimizar', 'info', 3000);
                
            } else {
                console.log('üü¢ ATIVANDO an√°lise otimizada...');
                
                // Limpar qualquer estado anterior antes de ativar
                clearAllHighlights();
                
                // Ativar: analisar e mostrar apenas alvos principais
                analyzeAndShowOptimizedTargets();
                optimizedAnalysisActive = true;
                
                // Atualizar bot√£o
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Mostrar Todos Alvos';
                btn.style.background = 'linear-gradient(135deg, #059669, #047857)';
                btn.disabled = false;
                
                console.log('‚úÖ ATIVADO - Novo estado:', optimizedAnalysisActive);
                showToast('üéØ An√°lise otimizada ativa - Mostrando apenas alvos principais', 'success', 3000);
            }
            
            // Log final para verificar
            setTimeout(() => {
                console.log('üîç Estado final an√°lise otimizada ap√≥s 500ms:', optimizedAnalysisActive);
            }, 500);
        }

        // Fun√ß√£o para analisar e mostrar apenas alvos com conex√µes mais fortes
        function analyzeAndShowOptimizedTargets() {
            if (!cy) return;
            
            console.log('üü¢ Iniciando an√°lise otimizada de alvos com conex√µes mais fortes...');

            // Salvar estado original completo apenas se n√£o foi salvo ainda
            if (!originalElementsOptimized) {
                originalElementsOptimized = cy.elements().jsons();
                console.log('üíæ Estado original salvo para an√°lise otimizada');
            } else {
                console.log('üìã Estado original j√° existe para an√°lise otimizada');
            }
            
            // Limpar qualquer destaque anterior
            cy.elements().removeClass('highlighted connection-highlighted selected');
            cy.elements().removeStyle();

            // Analisar for√ßa das conex√µes (valor + frequ√™ncia)
            const edges = cy.edges();
            const edgeStrength = [];

            edges.forEach(edge => {
                const label = edge.data('label');
                const numericValue = parseFloat(label.replace(/[^\d.-]/g, '')) || 0;
                edgeStrength.push({
                    edge: edge,
                    value: numericValue,
                    id: edge.id(),
                    source: edge.source().id(),
                    target: edge.target().id()
                });
            });

            // Ordenar conex√µes por for√ßa (valor)
            edgeStrength.sort((a, b) => b.value - a.value);
            
            // Pegar apenas as conex√µes mais fortes (top 25%)
            const strongThreshold = Math.max(2, Math.ceil(edgeStrength.length * 0.25));
            const strongestConnections = edgeStrength.slice(0, strongThreshold);

            // Identificar alvos principais baseados nas conex√µes mais fortes
            const targetNodeStrength = new Map();
            const relevantNodes = new Set();
            const relevantEdges = new Set();

            strongestConnections.forEach(item => {
                const sourceId = item.source;
                const targetId = item.target;
                
                // Calcular for√ßa do n√≥ baseado nas conex√µes fortes
                targetNodeStrength.set(sourceId, (targetNodeStrength.get(sourceId) || 0) + item.value);
                targetNodeStrength.set(targetId, (targetNodeStrength.get(targetId) || 0) + item.value);
                
                relevantNodes.add(sourceId);
                relevantNodes.add(targetId);
                relevantEdges.add(item.id);
            });

            // Identificar os alvos principais (n√≥s com maior for√ßa de conex√£o)
            const nodesByStrength = Array.from(targetNodeStrength.entries())
                .map(([nodeId, strength]) => ({
                    nodeId,
                    strength,
                    node: cy.getElementById(nodeId),
                    connections: cy.getElementById(nodeId).connectedEdges().length
                }))
                .sort((a, b) => b.strength - a.strength);

            // Pegar apenas os alvos principais (top 20% dos n√≥s mais fortes)
            const targetThreshold = Math.max(2, Math.ceil(nodesByStrength.length * 0.2));
            const primaryTargets = nodesByStrength.slice(0, targetThreshold);

            console.log(`üéØ Identificados ${primaryTargets.length} alvos principais de ${nodesByStrength.length} n√≥s`);

            // REMOVER completamente elementos n√£o relevantes (n√£o apenas ocultar)
            const elementsToRemove = [];
            cy.elements().forEach(element => {
                if (element.isNode()) {
                    if (!relevantNodes.has(element.id())) {
                        elementsToRemove.push(element);
                    }
                } else if (element.isEdge()) {
                    if (!relevantEdges.has(element.id())) {
                        elementsToRemove.push(element);
                    }
                }
            });

            // Remover elementos irrelevantes
            cy.remove(elementsToRemove);

            // Destacar alvos principais com cores diferenciadas
            primaryTargets.forEach((item, index) => {
                const intensity = Math.max(0.3, 1 - (index / primaryTargets.length));
                const borderColor = `rgba(124, 58, 237, ${intensity})`;
                const bgColor = `rgba(168, 85, 247, ${intensity * 0.8})`;
                
                item.node.style({
                    'border-width': 8 + (index === 0 ? 4 : 0), // Maior destaque para o primeiro
                    'border-color': borderColor,
                    'background-color': bgColor,
                    'box-shadow': `0 0 ${20 + (index === 0 ? 10 : 0)}px ${borderColor}`,
                    'z-index': 1000 - index
                });
            });

            // Aplicar estilos √†s conex√µes fortes com tonalidade de preto mais claro
            strongestConnections.forEach((item, index) => {
                const intensity = Math.max(0.4, 1 - (index / strongestConnections.length));
                const grayValue = Math.floor(50 + (intensity * 50)); // Entre #323232 e #646464
                const lineColor = `rgb(${grayValue}, ${grayValue}, ${grayValue})`;
                
                item.edge.style({
                    'line-color': lineColor, // Preto mais claro
                    'target-arrow-color': lineColor,
                    'width': 4 + (intensity * 4), // Largura vari√°vel baseada na for√ßa
                    'z-index': 999 - index
                });
            });

            // Destacar n√≥s conectados (mas n√£o principais)
            relevantNodes.forEach(nodeId => {
                const node = cy.getElementById(nodeId);
                if (!primaryTargets.find(item => item.nodeId === nodeId)) {
                    node.style({
                        'border-width': 3,
                        'border-color': '#6b21a8',
                        'z-index': 500
                    });
                }
            });

            // Aplicar layout otimizado que mant√©m a editabilidade
            const currentLayout = document.getElementById('layoutSelect')?.value || 'cose';
            cy.layout({
                name: currentLayout,
                animate: true,
                fit: true,
                padding: 50,
                nodeRepulsion: currentLayout === 'cose' ? 8000 : 4000,
                idealEdgeLength: currentLayout === 'cose' ? 100 : 80,
                edgeElasticity: currentLayout === 'cose' ? 200 : 100,
                nestingFactor: 1.2
            }).run();

            // Salvar dados da an√°lise otimizada
            optimizedAnalysisData = {
                totalNodes: cy.nodes().length, // N√≥s ap√≥s remo√ß√£o
                originalNodes: nodesByStrength.length, // N√≥s originais
                targetNodes: primaryTargets.length,
                totalConnections: cy.edges().length, // Conex√µes ap√≥s remo√ß√£o
                originalConnections: edges.length, // Conex√µes originais
                strongConnections: strongestConnections.length,
                threshold: targetThreshold,
                averageStrengthPerTarget: primaryTargets.reduce((sum, item) => sum + item.strength, 0) / primaryTargets.length,
                totalValueAnalyzed: strongestConnections.reduce((sum, item) => sum + item.value, 0)
            };

            // Mostrar estat√≠sticas
            showOptimizedAnalysisStats();
            
            console.log('‚úÖ An√°lise otimizada conclu√≠da');
            console.log(`üéØ ${primaryTargets.length} alvos principais, ${strongestConnections.length} conex√µes fortes`);
        }

        // Fun√ß√£o para restaurar grafo original da an√°lise otimizada
        function restoreOriginalGraphOptimized() {
            if (!cy || !originalElementsOptimized) return;
            
            console.log('üîÑ Restaurando grafo original da an√°lise otimizada...');

            // Limpar grafo atual completamente
            cy.elements().remove();
            
            // Restaurar elementos originais salvos
            cy.add(originalElementsOptimized);
            
            // Aplicar estilos padr√£o das conex√µes com preto mais claro
            cy.edges().style({
                'line-color': '#404040', // Preto mais claro
                'target-arrow-color': '#404040',
                'width': 3,
                'opacity': 1,
                'z-index': 1
            });
            
            // Aplicar estilos padr√£o dos n√≥s
            cy.nodes().style({
                'opacity': 1,
                'border-width': 2,
                'border-color': '#1e40af',
                'z-index': 1,
                'box-shadow': 'none',
                'background-color': '#60a5fa'
            });

            // Reorganizar layout respeitando a sele√ß√£o atual
            const currentLayout = document.getElementById('layoutSelect')?.value || 'cose';
            cy.layout({
                name: currentLayout,
                animate: true,
                fit: true,
                padding: 20,
                nodeRepulsion: currentLayout === 'cose' ? 4000 : 3000,
                idealEdgeLength: currentLayout === 'cose' ? 50 : 40,
                edgeElasticity: currentLayout === 'cose' ? 100 : 80,
                nestingFactor: 1
            }).run();

            // For√ßa a re-renderiza√ß√£o
            cy.forceRender();
            
            console.log('‚úÖ Grafo original da an√°lise otimizada restaurado completamente');
        }

        // Fun√ß√£o para mostrar estat√≠sticas da an√°lise otimizada
        function showOptimizedAnalysisStats() {
            if (!optimizedAnalysisData) return;

            const stats = optimizedAnalysisData;
            showToast(`
                <strong>üéØ An√°lise Otimizada - Conex√µes Mais Fortes</strong><br>
                üéØ ${stats.targetNodes} alvos principais de ${stats.originalNodes} originais (${Math.round(stats.targetNodes/stats.originalNodes*100)}%)<br>
                üîó ${stats.strongConnections} conex√µes fortes de ${stats.originalConnections} originais (${Math.round(stats.strongConnections/stats.originalConnections*100)}%)<br>
                üìä For√ßa m√©dia por alvo: R$ ${stats.averageStrengthPerTarget.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                üí∞ Valor total analisado: R$ ${stats.totalValueAnalyzed.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
            `, 'info', 8000);
        }

        // Fun√ß√£o para garantir reset completo do grafo
        function ensureGraphReset() {
            if (!cy) return;
            
            // Remover todos os estilos inline
            cy.elements().removeStyle();
            
            // Remover todas as classes
            cy.elements().removeClass();
            
            // Reaplicar estilos do zero
            cy.style(generateValueBasedStyles());
            
            // Garantir que as conex√µes tenham os estilos padr√£o em preto mais claro
            cy.edges().style({
                'line-color': '#404040', // Preto mais claro
                'target-arrow-color': '#404040',
                'width': 3
            });
            
            // Reset apenas da vari√°vel de highlight (n√£o das an√°lises especiais)
            currentHighlightedNode = null;
            
            // For√ßar re-renderiza√ß√£o
            cy.forceRender();
        }



        // Fun√ß√£o para filtrar por entidade
        function filterByEntity(entityName) {
            // Abrir painel de transa√ß√µes se n√£o estiver aberto
            if (document.getElementById('transactionsPanel').style.display === 'none') {
                showTransactionsPanel();
            }
            
            // Aplicar filtro
            document.getElementById('filterOrigin').value = entityName;
            document.getElementById('filterTarget').value = entityName;
            filterTransactions();
            
            showToast(`üîç Filtrado por entidade: ${entityName}`, 'info', 3000);
        }

        // Fun√ß√£o para ordenar tabela
        function sortTable(columnIndex) {
            const table = document.getElementById('transactionsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determinar dire√ß√£o da ordena√ß√£o
            const isAscending = table.dataset.sortDirection !== 'asc';
            table.dataset.sortDirection = isAscending ? 'asc' : 'desc';
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                // Se for coluna de valor, converter para n√∫mero
                if (columnIndex === 2) {
                    const aNum = parseFloat(aValue.replace(/[^\d.-]/g, '')) || 0;
                    const bNum = parseFloat(bValue.replace(/[^\d.-]/g, '')) || 0;
                    return isAscending ? aNum - bNum : bNum - aNum;
                }
                
                // Ordena√ß√£o alfab√©tica
                return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
            });
            
            // Reordenar linhas na tabela
            rows.forEach(row => tbody.appendChild(row));
            
            // Atualizar √≠cones de ordena√ß√£o
            table.querySelectorAll('th i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const currentIcon = table.querySelectorAll('th')[columnIndex].querySelector('i');
            currentIcon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
        }

        // Fun√ß√£o para minimizar/maximizar se√ß√µes
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggleBtn = document.getElementById(sectionId === 'customizationContent' ? 'customizationToggle' : 'controlsToggle');
            const icon = toggleBtn.querySelector('i');
            
            if (section.style.display === 'none' || section.classList.contains('section-collapsed')) {
                // Expandir se√ß√£o
                section.style.display = 'block';
                section.classList.remove('section-collapsed');
                section.classList.add('section-expanded');
                icon.className = 'fas fa-minus';
                
                const sectionName = sectionId === 'customizationContent' ? 'Personaliza√ß√£o Visual' : 'Controles Avan√ßados';
                showToast(`üìñ ${sectionName} expandida`, 'info', 2000);
            } else {
                // Minimizar se√ß√£o
                section.style.display = 'none';
                section.classList.remove('section-expanded');
                section.classList.add('section-collapsed');
                icon.className = 'fas fa-plus';
                
                const sectionName = sectionId === 'customizationContent' ? 'Personaliza√ß√£o Visual' : 'Controles Avan√ßados';
                showToast(`üìï ${sectionName} minimizada`, 'info', 2000);
            }
        }

        // Fun√ß√£o para gerar grafo customizado
        function generateCustomGraph() {
            const selectedFields = getSelectedFields();
            
            if (!selectedFields.source || !selectedFields.target) {
                showToast('‚ö†Ô∏è Selecione pelo menos os campos de Origem e Destino', 'warning');
                return;
            }
            
            if (!currentData || currentData.length === 0) {
                showToast('‚ö†Ô∏è Nenhum dado carregado!', 'warning');
                return;
            }
            
            const elementos = processFieldBasedDataToGraph(currentData);
            
            if (elementos.length === 0) {
                showToast('‚ö†Ô∏è N√£o foi poss√≠vel gerar grafo dos dados', 'warning');
                return;
            }
            
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elementos,
                style: generateValueBasedStyles(),
                layout: { name: 'cose', animate: true, fit: true, padding: 20 }
            });
            
            // Adicionar eventos
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const data = node.data();
                selectedNode = node; // Salvar n√≥ selecionado
                
                // Destacar n√≥ selecionado
                cy.nodes().removeClass('selected');
                node.addClass('selected');
                
                // Exibir informa√ß√µes detalhadas
                showDetailedNodeInfo(data);
            });
            
            cy.on('tap', 'edge', function(evt) {
                const edge = evt.target;
                const data = edge.data();
                
                showToast(`
                    <strong>Transa√ß√£o</strong><br>
                    ${data.source} ‚Üí ${data.target}<br>
                    Valor: ${data.label}
                `, 'info', 4000);
            });
            
            generateValueBasedLegend();
            showToast('‚úÖ Grafo customizado gerado com sucesso!', 'success');
        }

        // Fun√ß√£o para processar dados baseada em campos
        function processFieldBasedDataToGraph(data) {
            const selectedFields = getSelectedFields();
            const elementos = [];
            const nodes = new Set();
            const nodeConnections = new Map();
            const nodeValues = new Map();
            
            // Primeira passagem: coletar estat√≠sticas
            data.forEach((row, index) => {
                const source = row[selectedFields.source] ? String(row[selectedFields.source]).trim() : null;
                const target = row[selectedFields.target] ? String(row[selectedFields.target]).trim() : null;
                const value = row[selectedFields.value] ? String(row[selectedFields.value]).trim() : '';
                const numericValue = parseFloat(value.replace(/[^\d.-]/g, '')) || 0;
                
                if (source && target && source !== target) {
                    nodeConnections.set(source, (nodeConnections.get(source) || 0) + 1);
                    nodeConnections.set(target, (nodeConnections.get(target) || 0) + 1);
                    
                    nodeValues.set(source, (nodeValues.get(source) || 0) + numericValue);
                    nodeValues.set(target, (nodeValues.get(target) || 0) + numericValue);
                    
                    nodes.add(source);
                    nodes.add(target);
                }
            });
            
            // Segunda passagem: criar arestas
            data.forEach((row, index) => {
                const source = row[selectedFields.source] ? String(row[selectedFields.source]).trim() : null;
                const target = row[selectedFields.target] ? String(row[selectedFields.target]).trim() : null;
                const value = row[selectedFields.value] ? String(row[selectedFields.value]).trim() : '';
                const label = value || 'Conex√£o';
                
                if (source && target && source !== target) {
                    elementos.push({
                        data: {
                            id: `edge_${index}`,
                            source: source,
                            target: target,
                            label: label
                        }
                    });
                }
            });
            
            // Adicionar n√≥s com sistema de valor e campo
            nodes.forEach(nodeId => {
                const connections = nodeConnections.get(nodeId) || 0;
                const totalValue = nodeValues.get(nodeId) || 0;
                
                // Determinar tipo de n√≥ baseado no campo
                let nodeType = 'Padr√£o';
                let customIcon = 'fas fa-circle';
                
                const sourceNodes = new Set();
                const targetNodes = new Set();
                
                // Identificar se √© origem, destino ou ambos
                data.forEach(row => {
                    const source = row[selectedFields.source] ? String(row[selectedFields.source]).trim() : null;
                    const target = row[selectedFields.target] ? String(row[selectedFields.target]).trim() : null;
                    
                    if (source === nodeId) sourceNodes.add(nodeId);
                    if (target === nodeId) targetNodes.add(nodeId);
                });
                
                if (sourceNodes.has(nodeId) && targetNodes.has(nodeId)) {
                    nodeType = 'Ambos (Origem e Destino)';
                    customIcon = fieldIconConfig.both;
                } else if (sourceNodes.has(nodeId)) {
                    nodeType = 'Origem';
                    customIcon = fieldIconConfig.source;
                } else if (targetNodes.has(nodeId)) {
                    nodeType = 'Destino';
                    customIcon = fieldIconConfig.target;
                }
                
                // Sistema de cores baseado no valor
                const { color, size, shadow } = getNodeTypeByValue(totalValue);
                
                elementos.push({
                    data: {
                        id: nodeId,
                        label: nodeId,
                        nodeType: nodeType,
                        connections: connections,
                        totalValue: totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                        customIcon: customIcon,
                        customColor: color,
                        customSize: size,
                        customShadow: shadow,
                        numericValue: totalValue
                    }
                });
            });
            
            return elementos;
        }

        // Fun√ß√£o para gerar estilos baseados em valor
        function generateValueBasedStyles() {
            return [
                {
                    selector: 'node',
                    style: {
                        'background-color': 'data(customColor)',
                        'content': function(ele) {
                            const iconClass = ele.data('customIcon');
                            const label = ele.data('label');
                            const iconText = getIconText(iconClass);
                            return `${iconText}\n${label}`;
                        },
                        'color': '#ffffff',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': function(ele) {
                            const size = ele.data('customSize');
                            return `${Math.max(14, size * 0.25)}px`;
                        },
                        'font-weight': 'bold',
                        'width': 'data(customSize)',
                        'height': 'data(customSize)',
                        'border-width': 4,
                        'border-color': '#ffffff',
                        'text-outline-width': 2,
                        'text-outline-color': '#000000',
                        'text-outline-opacity': 0.8,
                        'box-shadow': 'data(customShadow)',
                        'text-wrap': 'wrap',
                        'text-max-width': 'data(customSize)',
                        'shape': 'ellipse',
                        'transition-property': 'all',
                        'transition-duration': '0.3s'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'line-color': '#6b7280',
                        'target-arrow-shape': 'triangle',
                        'target-arrow-color': '#6b7280',
                        'curve-style': 'bezier',
                        'label': 'data(label)',
                        'font-size': '9px',
                        'color': '#333',
                        'text-rotation': 'autorotate',
                        'width': 2,
                        'text-background-color': '#ffffff',
                        'text-background-opacity': 0.8,
                        'text-background-padding': '3px'
                    }
                },
                {
                    selector: 'node:selected',
                    style: {
                        'border-color': '#fbbf24',
                        'border-width': 5,
                        'box-shadow': '0 0 20px #fbbf24'
                    }
                },
                {
                    selector: 'edge:selected',
                    style: {
                        'line-color': '#fbbf24',
                        'target-arrow-color': '#fbbf24',
                        'width': 4
                    }
                },
                {
                    selector: 'node.highlighted',
                    style: {
                        'border-width': 6,
                        'border-color': '#fbbf24',
                        'box-shadow': '0 0 20px #fbbf24'
                    }
                },
                {
                    selector: 'node.selected',
                    style: {
                        'border-width': 8,
                        'border-color': '#ef4444',
                        'box-shadow': '0 0 25px #ef4444'
                    }
                },
                {
                    selector: 'edge.highlighted',
                    style: {
                        'line-color': '#fbbf24',
                        'target-arrow-color': '#fbbf24',
                        'width': 4,
                        'opacity': 1
                    }
                },
                {
                    selector: 'edge.connection-highlighted',
                    style: {
                        'line-color': '#dc2626',
                        'target-arrow-color': '#dc2626',
                        'width': 6,
                        'opacity': 1,
                        'z-index': 999,
                        'overlay-opacity': 0,
                        'overlay-color': '#dc2626',
                        'overlay-padding': '3px'
                    }
                }
            ];
        }

        // Fun√ß√£o para calcular estat√≠sticas anal√≠ticas
        function calculateAnalytics() {
            if (!currentData || currentData.length === 0) return null;
            
            const selectedFields = getSelectedFields();
            const stats = {
                ultraAlto: 0,    // >= 1M
                muitoAlto: 0,    // >= 500K
                roxoAlto: 0,     // >= 250K
                alto: 0,         // >= 100K
                medio: 0,        // >= 50K
                medioBaixo: 0,   // >= 10K
                baixo: 0,        // < 10K
                totalTransacoes: 0,
                valorTotal: 0,
                entidadesOrigem: new Set(),
                entidadesDestino: new Set(),
                entidadesAmbos: new Set()
            };
            
            currentData.forEach(row => {
                const source = row[selectedFields.source] ? String(row[selectedFields.source]).trim() : null;
                const target = row[selectedFields.target] ? String(row[selectedFields.target]).trim() : null;
                const value = row[selectedFields.value] ? String(row[selectedFields.value]).trim() : '';
                const numericValue = parseFloat(value.replace(/[^\d.-]/g, '')) || 0;
                
                if (source && target && source !== target) {
                    stats.totalTransacoes++;
                    stats.valorTotal += numericValue;
                    
                    // Classificar por valor
                    if (numericValue >= 1000000) {
                        stats.ultraAlto++;
                    } else if (numericValue >= 500000) {
                        stats.muitoAlto++;
                    } else if (numericValue >= 250000) {
                        stats.roxoAlto++;
                    } else if (numericValue >= 100000) {
                        stats.alto++;
                    } else if (numericValue >= 50000) {
                        stats.medio++;
                    } else if (numericValue >= 10000) {
                        stats.medioBaixo++;
                    } else {
                        stats.baixo++;
                    }
                    
                    // Contabilizar entidades
                    stats.entidadesOrigem.add(source);
                    stats.entidadesDestino.add(target);
                    
                    // Verificar se aparece em ambos os campos
                    if (stats.entidadesOrigem.has(target) || stats.entidadesDestino.has(source)) {
                        stats.entidadesAmbos.add(source);
                        stats.entidadesAmbos.add(target);
                    }
                }
            });
            
            return stats;
        }

        // Fun√ß√£o para gerar legenda baseada em valor
        function generateValueBasedLegend() {
            const legendContent = document.getElementById('legendContent');
            legendContent.innerHTML = '';
            
            const legendDiv = document.createElement('div');
            legendDiv.className = 'legend-grid';
            
            const analytics = calculateAnalytics();
            
            legendDiv.innerHTML = `
                <div class="legend-section">
                    <h5>üí∞ Sistema de Cores por Valor:</h5>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626; box-shadow: 0 0 10px rgba(220, 38, 38, 0.6);"></div>
                            <span>üî¥ Ultra Alto (‚â• R$ 1M) - ${analytics ? analytics.ultraAlto : 0} transa√ß√µes</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ea580c; box-shadow: 0 0 8px rgba(234, 88, 12, 0.5);"></div>
                            <span>üü† Muito Alto (‚â• R$ 500K) - ${analytics ? analytics.muitoAlto : 0} transa√ß√µes</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #7c3aed; box-shadow: 0 0 6px rgba(124, 58, 237, 0.4);"></div>
                            <span>üü£ Roxo Alto (‚â• R$ 250K) - ${analytics ? analytics.roxoAlto : 0} transa√ß√µes</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #eab308;"></div>
                            <span>üü° Alto (‚â• R$ 100K) - ${analytics ? analytics.alto : 0} transa√ß√µes</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2563eb;"></div>
                            <span>üîµ M√©dio (‚â• R$ 50K) - ${analytics ? analytics.medio : 0} transa√ß√µes</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #60a5fa;"></div>
                            <span>üî∑ M√©dio-Baixo (‚â• R$ 10K) - ${analytics ? analytics.medioBaixo : 0} transa√ß√µes</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #059669;"></div>
                            <span>üü¢ Baixo (< R$ 10K) - ${analytics ? analytics.baixo : 0} transa√ß√µes</span>
                        </div>
                    </div>
                </div>
                
                <div class="legend-section">
                    <h5>üìä Resumo Anal√≠tico:</h5>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span><strong>Total de Transa√ß√µes:</strong> ${analytics ? analytics.totalTransacoes.toLocaleString() : 0}</span>
                        </div>
                        <div class="legend-item">
                            <span><strong>Valor Total Movimentado:</strong> ${analytics ? analytics.valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00'}</span>
                        </div>
                        <div class="legend-item">
                            <span><strong>Entidades √önicas:</strong> ${analytics ? (analytics.entidadesOrigem.size + analytics.entidadesDestino.size - analytics.entidadesAmbos.size) : 0}</span>
                        </div>
                        <div class="legend-item">
                            <span><strong>Ticket M√©dio:</strong> ${analytics && analytics.totalTransacoes > 0 ? (analytics.valorTotal / analytics.totalTransacoes).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="legend-section">
                    <h5>üéØ √çcones por Campo:</h5>
                    <div class="legend-items">
                        <div class="legend-item">
                            <i class="${fieldIconConfig.source}" style="color: #fbbf24; margin-right: 8px;"></i>
                            <span>Origem: ${availableIcons[fieldIconConfig.source]}</span>
                        </div>
                        <div class="legend-item">
                            <i class="${fieldIconConfig.target}" style="color: #fbbf24; margin-right: 8px;"></i>
                            <span>Destino: ${availableIcons[fieldIconConfig.target]}</span>
                        </div>
                        <div class="legend-item">
                            <i class="${fieldIconConfig.both}" style="color: #fbbf24; margin-right: 8px;"></i>
                            <span>Ambos: ${availableIcons[fieldIconConfig.both]}</span>
                        </div>
                    </div>
                </div>
                
                <div class="legend-section">
                    <h5>üí° Dicas de Uso:</h5>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span>üñ±Ô∏è Clique nos n√≥s para ver detalhes</span>
                        </div>
                        <div class="legend-item">
                            <span>üéØ Use layouts diferentes para an√°lises variadas</span>
                        </div>
                        <div class="legend-item">
                            <span>üí∞ Cores autom√°ticas baseadas no volume de transa√ß√µes</span>
                        </div>
                        <div class="legend-item">
                            <span>üé® √çcones personaliz√°veis por campo (origem/destino)</span>
                        </div>
                    </div>
                </div>
            `;
            
            legendContent.appendChild(legendDiv);
        }

        // Fun√ß√£o para aplicar layout
        function aplicarLayout() {
            if (!cy) {
                showToast('‚ö†Ô∏è Gere o grafo primeiro!', 'warning');
                return;
            }

            const tipoLayout = document.getElementById('layoutSelect').value;
            
            let layoutOptions = {
                name: tipoLayout,
                animate: true,
                fit: true,
                padding: 20
            };

            switch(tipoLayout) {
                case 'breadthfirst':
                    layoutOptions.directed = true;
                    layoutOptions.spacingFactor = 1.5;
                    break;
                case 'circle':
                    layoutOptions.radius = 200;
                    break;
                case 'concentric':
                    layoutOptions.concentric = function(node) {
                        return node.degree();
                    };
                    layoutOptions.levelWidth = function(nodes) {
                        return 2;
                    };
                    break;
                case 'grid':
                    layoutOptions.rows = Math.ceil(Math.sqrt(cy.nodes().length));
                    break;
                case 'cose':
                    layoutOptions.idealEdgeLength = 100;
                    layoutOptions.nodeOverlap = 20;
                    break;
            }

            cy.layout(layoutOptions).run();
            showToast(`‚úÖ Layout "${tipoLayout}" aplicado!`, 'success');
        }
    </script>
</body>
</html> 