#!/usr/bin/env python3
"""
Aplica√ß√£o Streamlit Avan√ßada para Investiga√ß√£o de Fraudes
Interface moderna e robusta para an√°lise investigativa
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
from advanced_fraud_analyzer import AdvancedFraudAnalyzer
import io
import base64
from datetime import datetime
import json

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="üîç Investiga√ß√£o Avan√ßada de Fraudes",
    page_icon="üîç",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS customizado
st.markdown("""
<style>
    .main-header {
        font-size: 3rem;
        font-weight: bold;
        color: #e74c3c;
        text-align: center;
        margin-bottom: 2rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .section-header {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
        margin: 1rem 0;
        padding: 0.5rem;
        background: linear-gradient(90deg, #f8f9fa, #e9ecef);
        border-left: 4px solid #e74c3c;
    }
    
    .risk-critical {
        background-color: #dc3545;
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        font-weight: bold;
    }
    
    .risk-high {
        background-color: #fd7e14;
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        font-weight: bold;
    }
    
    .risk-medium {
        background-color: #ffc107;
        color: black;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        font-weight: bold;
    }
    
    .risk-low {
        background-color: #28a745;
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        font-weight: bold;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem;
        border-radius: 1rem;
        color: white;
        margin: 0.5rem 0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .alert-box {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
    
    .sidebar .sidebar-content {
        background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
    }
    
    .stButton > button {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        border: none;
        padding: 0.5rem 2rem;
        font-weight: bold;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stButton > button:hover {
        background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }
</style>
""", unsafe_allow_html=True)

# T√≠tulo principal
st.markdown('<h1 class="main-header">üîç INVESTIGA√á√ÉO AVAN√áADA DE FRAUDES</h1>', unsafe_allow_html=True)

# Inicializar o analisador na sess√£o
if 'analyzer' not in st.session_state:
    st.session_state.analyzer = AdvancedFraudAnalyzer()
    st.session_state.data_loaded = False
    st.session_state.analysis_complete = False
    st.session_state.investigation_results = {}

# Sidebar para configura√ß√µes
st.sidebar.markdown("## ‚öôÔ∏è Configura√ß√µes de Investiga√ß√£o")
st.sidebar.markdown("---")

# Upload de arquivo
st.sidebar.markdown("### üìÅ Carregar Dados")
uploaded_file = st.sidebar.file_uploader(
    "Arquivo de Transa√ß√µes",
    type=['csv', 'xlsx', 'xls'],
    help="Carregue dados de transa√ß√µes financeiras para an√°lise"
)

# Configura√ß√µes de detec√ß√£o
st.sidebar.markdown("### üéØ Par√¢metros de Detec√ß√£o")

alert_threshold = st.sidebar.number_input(
    "Limiar de Alerta (R$)", 
    min_value=1000, 
    max_value=1000000, 
    value=10000, 
    step=1000,
    help="Valor m√≠nimo para gerar alertas"
)

structuring_threshold = st.sidebar.number_input(
    "Limiar de Estrutura√ß√£o (R$)", 
    min_value=5000, 
    max_value=500000, 
    value=10000, 
    step=1000,
    help="Limiar para detectar fracionamento de valores"
)

tolerance = st.sidebar.slider(
    "Toler√¢ncia de Similaridade", 
    min_value=0.05, 
    max_value=0.5, 
    value=0.1, 
    step=0.05,
    help="Toler√¢ncia para detectar valores similares (estrutura√ß√£o)"
)

# Carregar dados
if uploaded_file is not None:
    try:
        # Determinar tipo de arquivo
        file_extension = uploaded_file.name.split('.')[-1].lower()
        
        if file_extension == 'csv':
            df = pd.read_csv(uploaded_file)
        else:
            df = pd.read_excel(uploaded_file)
        
        # Carregar no analisador
        st.session_state.analyzer.data = df
        st.session_state.analyzer._clean_financial_data()
        st.session_state.analyzer._parse_dates()
        st.session_state.analyzer.alert_threshold = alert_threshold
        st.session_state.analyzer.structuring_threshold = structuring_threshold
        
        st.session_state.data_loaded = True
        
        st.sidebar.success(f"‚úÖ Dados carregados!")
        st.sidebar.info(f"üìä {len(df)} transa√ß√µes, {len(df.columns)} colunas")
        
        # Detectar colunas automaticamente
        columns = list(df.columns)
        
        # Configura√ß√µes das colunas
        st.sidebar.markdown("### üîó Mapeamento de Colunas")
        
        # Detectar colunas automaticamente
        name_cols = [col for col in columns if any(x in col.lower() for x in ['nome', 'name', 'pessoa', 'person'])]
        company_cols = [col for col in columns if any(x in col.lower() for x in ['empresa', 'company', 'corpora√ß√£o'])]
        value_cols = [col for col in columns if any(x in col.lower() for x in ['valor', 'value', 'amount', 'quantia'])]
        date_cols = [col for col in columns if any(x in col.lower() for x in ['data', 'date', 'quando'])]
        
        source_col = st.sidebar.selectbox(
            "Coluna de Origem (Pessoa/Entidade)",
            columns,
            index=columns.index(name_cols[0]) if name_cols else 0,
            help="Coluna que identifica quem fez a transa√ß√£o"
        )
        
        target_col = st.sidebar.selectbox(
            "Coluna de Destino (Empresa/Entidade)",
            columns,
            index=columns.index(company_cols[0]) if company_cols else 1,
            help="Coluna que identifica o destino da transa√ß√£o"
        )
        
        value_col = st.sidebar.selectbox(
            "Coluna de Valor",
            columns,
            index=columns.index(value_cols[0]) if value_cols else 2,
            help="Coluna com os valores das transa√ß√µes"
        )
        
        date_col = st.sidebar.selectbox(
            "Coluna de Data (opcional)",
            ["Nenhuma"] + columns,
            index=columns.index(date_cols[0]) + 1 if date_cols else 0,
            help="Coluna com as datas das transa√ß√µes"
        )
        date_col = None if date_col == "Nenhuma" else date_col
        
        # Bot√£o para iniciar an√°lise
        if st.sidebar.button("üöÄ INICIAR INVESTIGA√á√ÉO", type="primary"):
            with st.spinner("üîç Realizando an√°lise investigativa..."):
                # Construir rede
                success = st.session_state.analyzer.build_transaction_network(
                    source_col=source_col,
                    target_col=target_col,
                    value_col=value_col,
                    date_col=date_col
                )
                
                if success:
                    # Executar an√°lises
                    results = st.session_state.analyzer.generate_comprehensive_report()
                    st.session_state.investigation_results = results
                    st.session_state.analysis_complete = True
                    st.sidebar.success("‚úÖ Investiga√ß√£o conclu√≠da!")
                else:
                    st.sidebar.error("‚ùå Erro na an√°lise")
        
    except Exception as e:
        st.sidebar.error(f"‚ùå Erro ao carregar arquivo: {e}")
        st.session_state.data_loaded = False

# √Årea principal
if not st.session_state.data_loaded:
    # Tela de boas-vindas
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        st.markdown("""
        <div class="alert-box">
        <h3>üéØ Sistema de Investiga√ß√£o Avan√ßada</h3>
        <p>Esta ferramenta utiliza algoritmos avan√ßados de detec√ß√£o de fraudes para identificar:</p>
        <ul>
            <li><strong>Estrutura√ß√£o (Fracionamento)</strong>: Divis√£o de valores para evitar detec√ß√£o</li>
            <li><strong>Transa√ß√µes Circulares</strong>: Ciclos suspeitos de movimenta√ß√£o</li>
            <li><strong>Entidades Centrais</strong>: Pessoas/empresas com muitas conex√µes</li>
            <li><strong>Padr√µes Incomuns</strong>: Outliers e anomalias</li>
            <li><strong>An√°lise Temporal</strong>: Atividades em hor√°rios suspeitos</li>
        </ul>
        </div>
        """, unsafe_allow_html=True)
        
        st.markdown("""
        ### üìã Formato dos Dados
        
        Sua planilha deve conter:
        - **Pessoa/Entidade**: Quem fez a transa√ß√£o
        - **Empresa/Destino**: Para onde foi a transa√ß√£o  
        - **Valor**: Quantia da transa√ß√£o
        - **Data**: Quando ocorreu (opcional)
        
        **Exemplo:**
        | Nome | Empresa | Valor | Data |
        |------|---------|-------|------|
        | Jo√£o Silva | ABC Corp | 95000 | 15/01/2024 |
        | Maria Santos | XYZ Ltda | 180000 | 18/01/2024 |
        """)

elif not st.session_state.analysis_complete:
    # Mostrar preview dos dados
    st.markdown('<div class="section-header">üìã Preview dos Dados Carregados</div>', unsafe_allow_html=True)
    
    df = st.session_state.analyzer.data
    st.dataframe(df.head(10), use_container_width=True)
    
    # M√©tricas b√°sicas
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("üìä Total de Transa√ß√µes", len(df))
    with col2:
        st.metric("üí∞ Valor Total", f"R$ {df['valor'].sum():,.2f}")
    with col3:
        st.metric("üë• Pessoas √önicas", df['nome'].nunique())
    with col4:
        st.metric("üè¢ Empresas √önicas", df['empresa'].nunique())
    
    # Gr√°ficos de distribui√ß√£o
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### üìà Distribui√ß√£o de Valores")
        fig = px.histogram(df, x='valor', nbins=30, title="Distribui√ß√£o de Valores das Transa√ß√µes")
        fig.update_layout(xaxis_title="Valor (R$)", yaxis_title="Frequ√™ncia")
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        st.markdown("### üë• Top Pessoas por Transa√ß√µes")
        top_people = df['nome'].value_counts().head(10)
        fig = px.bar(x=top_people.values, y=top_people.index, orientation='h',
                     title="Pessoas com Mais Transa√ß√µes")
        fig.update_layout(xaxis_title="N√∫mero de Transa√ß√µes", yaxis_title="Pessoa")
        st.plotly_chart(fig, use_container_width=True)

else:
    # Interface principal com an√°lise completa
    results = st.session_state.investigation_results
    analyzer = st.session_state.analyzer
    
    # Score de risco geral
    risk_score = results.get('risk_score', 0)
    
    if risk_score >= 70:
        risk_class = "risk-critical"
        risk_text = "üö® RISCO CR√çTICO"
        risk_desc = "Investiga√ß√£o imediata recomendada"
    elif risk_score >= 40:
        risk_class = "risk-high"
        risk_text = "‚ö†Ô∏è RISCO ALTO"
        risk_desc = "Monitoramento intensivo recomendado"
    elif risk_score >= 20:
        risk_class = "risk-medium"
        risk_text = "‚ö° RISCO M√âDIO"
        risk_desc = "Monitoramento regular recomendado"
    else:
        risk_class = "risk-low"
        risk_text = "‚úÖ RISCO BAIXO"
        risk_desc = "Padr√µes normais detectados"
    
    st.markdown(f"""
    <div class="{risk_class}">
        <h3>{risk_text}</h3>
        <p>Score de Risco: {risk_score}/100</p>
        <p>{risk_desc}</p>
    </div>
    """, unsafe_allow_html=True)
    
    # M√©tricas principais
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        st.metric("üìä Transa√ß√µes", len(analyzer.data))
    with col2:
        st.metric("üï∏Ô∏è Entidades", analyzer.graph.number_of_nodes())
    with col3:
        st.metric("üîó Conex√µes", analyzer.graph.number_of_edges())
    with col4:
        st.metric("üí∞ Valor Total", f"R$ {analyzer.data['valor'].sum():,.2f}")
    with col5:
        st.metric("üéØ Score Risco", f"{risk_score}/100")
    
    # Tabs para diferentes an√°lises
    tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
        "üîç Vis√£o Geral", "üìä Estrutura√ß√£o", "üîÑ Ciclos", 
        "üéØ Entidades Centrais", "üö® Padr√µes Incomuns", "üï∏Ô∏è Visualiza√ß√£o"
    ])
    
    with tab1:
        st.markdown('<div class="section-header">üìã Resumo Executivo</div>', unsafe_allow_html=True)
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("### üìä Estat√≠sticas Gerais")
            st.write(f"‚Ä¢ **Transa√ß√µes analisadas**: {len(analyzer.data)}")
            st.write(f"‚Ä¢ **Entidades √∫nicas**: {analyzer.graph.number_of_nodes()}")
            st.write(f"‚Ä¢ **Conex√µes totais**: {analyzer.graph.number_of_edges()}")
            st.write(f"‚Ä¢ **Valor total**: R$ {analyzer.data['valor'].sum():,.2f}")
            
            st.markdown("### üö® Alertas Detectados")
            st.write(f"‚Ä¢ **Estrutura√ß√£o**: {len(results.get('structuring', []))}")
            st.write(f"‚Ä¢ **Ciclos suspeitos**: {len(results.get('circular', []))}")
            st.write(f"‚Ä¢ **Padr√µes incomuns**: {len(results.get('unusual', []))}")
            st.write(f"‚Ä¢ **Padr√µes temporais**: {len(results.get('temporal', []))}")
        
        with col2:
            # Gr√°fico de alertas
            alert_data = {
                'Tipo': ['Estrutura√ß√£o', 'Ciclos', 'Incomuns', 'Temporais'],
                'Quantidade': [
                    len(results.get('structuring', [])),
                    len(results.get('circular', [])),
                    len(results.get('unusual', [])),
                    len(results.get('temporal', []))
                ]
            }
            
            fig = px.bar(alert_data, x='Tipo', y='Quantidade', 
                        title="Alertas por Categoria",
                        color='Quantidade', color_continuous_scale='Reds')
            st.plotly_chart(fig, use_container_width=True)
    
    with tab2:
        st.markdown('<div class="section-header">üìä An√°lise de Estrutura√ß√£o (Fracionamento)</div>', unsafe_allow_html=True)
        
        structuring = results.get('structuring', [])
        
        if structuring:
            st.warning(f"‚ö†Ô∏è {len(structuring)} padr√µes de estrutura√ß√£o detectados!")
            
            # Criar DataFrame para exibi√ß√£o
            struct_df = pd.DataFrame(structuring)
            
            # Mostrar tabela
            st.dataframe(struct_df, use_container_width=True)
            
            # Gr√°fico de estrutura√ß√£o
            if len(structuring) > 0:
                fig = px.scatter(struct_df, x='transaction_count', y='total_value',
                               size='avg_value', color='risk_level',
                               hover_data=['person'], 
                               title="Padr√µes de Estrutura√ß√£o Detectados")
                fig.update_layout(xaxis_title="N√∫mero de Transa√ß√µes", yaxis_title="Valor Total (R$)")
                st.plotly_chart(fig, use_container_width=True)
        else:
            st.success("‚úÖ Nenhum padr√£o de estrutura√ß√£o detectado")
    
    with tab3:
        st.markdown('<div class="section-header">üîÑ An√°lise de Transa√ß√µes Circulares</div>', unsafe_allow_html=True)
        
        circular = results.get('circular', [])
        
        if circular:
            st.error(f"üö® {len(circular)} ciclos suspeitos detectados!")
            
            for i, cycle in enumerate(circular[:5]):  # Mostrar top 5
                st.markdown(f"### Ciclo {i+1}")
                st.write(f"**Entidades**: {' ‚Üí '.join(cycle['cycle'])}")
                st.write(f"**Valor Total**: R$ {cycle['total_value']:,.2f}")
                st.write(f"**Tamanho do Ciclo**: {cycle['cycle_length']} entidades")
                st.write(f"**N√≠vel de Risco**: {cycle['risk_level']}")
                st.markdown("---")
        else:
            st.success("‚úÖ Nenhum ciclo suspeito detectado")
    
    with tab4:
        st.markdown('<div class="section-header">üéØ Entidades Centrais (Hubs)</div>', unsafe_allow_html=True)
        
        hubs = results.get('hubs', [])
        
        if hubs:
            st.info(f"üìà Top {len(hubs)} entidades mais conectadas")
            
            # Criar DataFrame
            hubs_df = pd.DataFrame(hubs)
            
            # Mostrar tabela
            st.dataframe(hubs_df, use_container_width=True)
            
            # Gr√°fico de centralidade
            fig = px.scatter(hubs_df, x='total_connections', y='total_flow',
                           size='centrality_score', color='risk_level',
                           hover_data=['entity'], 
                           title="Entidades Centrais por Conex√µes e Fluxo")
            fig.update_layout(xaxis_title="Total de Conex√µes", yaxis_title="Fluxo Total (R$)")
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.info("üìä An√°lise de entidades centrais n√£o dispon√≠vel")
    
    with tab5:
        st.markdown('<div class="section-header">üö® Padr√µes Incomuns</div>', unsafe_allow_html=True)
        
        unusual = results.get('unusual', [])
        
        if unusual:
            st.warning(f"‚ö†Ô∏è {len(unusual)} padr√µes incomuns detectados!")
            
            # Separar por tipo
            outliers = [p for p in unusual if p['type'] == 'high_value_outlier']
            high_freq = [p for p in unusual if p['type'] == 'high_frequency']
            
            if outliers:
                st.markdown("### üí∞ Outliers de Valor Alto")
                outlier_df = pd.DataFrame(outliers)
                st.dataframe(outlier_df, use_container_width=True)
            
            if high_freq:
                st.markdown("### üîÅ Alta Frequ√™ncia de Transa√ß√µes")
                freq_df = pd.DataFrame(high_freq)
                st.dataframe(freq_df, use_container_width=True)
        else:
            st.success("‚úÖ Nenhum padr√£o incomum detectado")
    
    with tab6:
        st.markdown('<div class="section-header">üï∏Ô∏è Visualiza√ß√£o da Rede</div>', unsafe_allow_html=True)
        
        # Criar visualiza√ß√£o
        fig = analyzer.create_investigation_visualization()
        
        if fig:
            st.plotly_chart(fig, use_container_width=True)
            
            # Controles de visualiza√ß√£o
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("### üìä Legenda")
                st.markdown("""
                - **Tamanho do n√≥**: Proporcional ao fluxo total
                - **Cor do n√≥**: Baseada no fluxo l√≠quido (entrada - sa√≠da)
                - **Azul**: Mais entrada que sa√≠da
                - **Vermelho**: Mais sa√≠da que entrada
                """)
            
            with col2:
                st.markdown("### üéØ Interpreta√ß√£o")
                st.markdown("""
                - **N√≥s grandes**: Entidades com alto volume de transa√ß√µes
                - **N√≥s centrais**: Poss√≠veis intermedi√°rios ou concentradores
                - **Clusters**: Grupos de entidades conectadas
                - **Conex√µes grossas**: Relacionamentos financeiros intensos
                """)
        else:
            st.error("‚ùå Erro ao gerar visualiza√ß√£o")
    
    # Bot√£o para exportar relat√≥rio
    st.markdown("---")
    col1, col2, col3 = st.columns([1, 1, 1])
    
    with col2:
        if st.button("üìÑ EXPORTAR RELAT√ìRIO COMPLETO", type="primary"):
            try:
                filename = analyzer.export_investigation_report()
                st.success(f"‚úÖ Relat√≥rio exportado: {filename}")
            except Exception as e:
                st.error(f"‚ùå Erro ao exportar: {e}")

# Footer com informa√ß√µes
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #666; font-size: 0.8rem;">
    üîç Sistema de Investiga√ß√£o Avan√ßada de Fraudes | 
    Desenvolvido para an√°lise investigativa profissional | 
    Use com responsabilidade e dentro dos aspectos legais
</div>
""", unsafe_allow_html=True)